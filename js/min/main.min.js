"use strict";!function(e){function t(t){return!!e(t).sbLoading()||(e(t).sbLoading(!0),!1)}function i(e,t=W){return ie.storage(e,t)}function s(e){return ie.translate(e)}function a(e=-1){if(-1===e)return window.sb_current_user;window.sb_current_user=e}function n(){let e=$?SB_ADMIN_SETTINGS.sound.volume:P.sound.volume;re.audio&&e&&(re.audio.volume=e)}function o(e){let t=Math.floor(e/60);return e-=60*t,(t||"0")+":"+(e<10?"0"+e:e)}function r(){(l=e(".sb-admin, .sb-chat, .sb-tickets")).length&&typeof SB_AJAX_URL!=W?(h=l.find(".sb-list").eq(0),g=l.find(".sb-editor"),p=g.find("textarea"),_=l.find($||E?".sb-list":"> div > .sb-scroll-area"),y=l.find(".sb-label-date-top"),f=_.find(".sb-header"),v=g.find(".sb-emoji"),b=l.find(".sb-overlay-panel"),m=E?l.find(".sb-profile-agent .sb-status"):null,re.enabledAutoExpand(),re.audio=l.find("#sb-audio").get(0),ie.cookie("sb-check","ok",1,"set"),"ok"!=ie.cookie("sb-check")?(z=!1,console.warn("Support Board: cookies not available.")):ie.cookie("sb-check",!1,!1,!1),$?(n(),ie.event("SBReady")):ie.ajax({function:"get-front-settings",current_url:window.location.href,tickets:E,popup:!i("popup")&&!E},t=>{if(P=t,typeof SB_LOCAL_SETTINGS!=W&&e.extend(P,SB_LOCAL_SETTINGS),w=P.bot_id,S=P.dialogflow_human_takeover,F=P.agents_online,se.active=P.pusher,P.language&&(SB_LANG="auto"!=P.language?[P.language,"front"]:!(!te||"en"==Shopify.locale)&&Shopify.locale),typeof SB_REGISTRATION_REQUIRED!=W&&(P.registration_required=SB_REGISTRATION_REQUIRED,P.tickets_registration_required=SB_REGISTRATION_REQUIRED),typeof SB_ARTICLES_PAGE!=W&&SB_ARTICLES_PAGE&&(re.automations.runAll(),re.initArticlesPage()),E&&P.tickets_manual_init||(!E||P.tickets_manual_init)&&(P.chat_manual_init||P.disable_offline&&!F||P.disable_office_hours&&!P.office_hours||P.chat_login_init&&!de.login())||re.initChat(),P.cron&&setTimeout(function(){ie.ajax({function:"cron-jobs"})},1e4),P.cron_email_piping&&setTimeout(function(){ie.ajax({function:"email-piping"})},8e3),P.push_notifications_users&&ie.serviceWorker.init(),E&&(P.tickets_default_department&&(re.default_department=P.tickets_default_department),P.dialogflow_disable_tickets&&(P.dialogflow_active=!1,P.open_ai_active=!1)),de.is("martfury")){let e=!1;setInterval(function(){if(a()){let t=ie.cookie("XSRF-TOKEN");t&&t!=e&&(ie.ajax({function:"martfury-session"}),e=t)}},3e3)}te&&(de.shopify.startCartSynchronization(),l.addClass("sb-shopify")),n(),de.aecommerce.cart(),setTimeout(()=>{ie.event("SBReady")},500)}),e(g).on("keydown","textarea",function(e){if(13==e.which&&(!E||P.tickets_enter_button)&&(!$||!e.ctrlKey&&!e.shiftKey))return re.submit(),e.preventDefault,!1;$&&13==e.which&&e.ctrlKey&&re.insertText("\n")}),e(l).on("keydown",".sb-dashboard-articles input",function(t){13==t.which&&e(this).next().click()}),typeof SB_DEFAULT_DEPARTMENT!==W&&(re.default_department=SB_DEFAULT_DEPARTMENT),typeof SB_DEFAULT_AGENT!==W&&(re.default_agent=SB_DEFAULT_AGENT),typeof SB_DIALOGFLOW_TAGS!==W&&(re.default_tags=SB_DEFAULT_TAGS),typeof SB_DIALOGFLOW_AGENT!==W&&(de.dialogflow.project_id=SB_DIALOGFLOW_AGENT)):ie.event("SBReady"),document.addEventListener("visibilitychange",function(){ie.visibilityChange(document.visibilityState)},!1),e(l).on("click",function(){re.tab_active||ie.visibilityChange()}),c=l,$&&(l=l.find(".sb-conversation")),e(_).on("scroll",function(){let t=_.scrollTop(),i=N.length;if(re.scrollHeader(),D&&(y.sbActive(!0),clearTimeout(R[0]),R[0]=setTimeout(()=>{y.sbActive(!1)},1500)),i)if(re.isBottom())y.html(e(N[i-1]).html());else for(var s=0;s<i;s++){let i=N[s].getBoundingClientRect().top;if(i>100&&i<150){let i=e(N[U[0]>t&&s>0?s-1:s]).html();i!=U[1]&&(y.html(i),U[1]=i);break}}U[0]=t}),e(h).on("click",".sb-menu-btn",function(){let t=e(this).parent().find(".sb-menu"),i=e(t).sbActive();ie.deactivateAll(),i||(e(t).sbActive(!0),ie.deselectAll(),$&&(SBAdmin.open_popup=t))}),q&&(e(g).on("click",".sb-textarea",function(){l.addClass("sb-header-hidden"),e(this).find("textarea").get(0).focus(),re.isBottom()&&(re.scrollBottom(),setTimeout(()=>{re.scrollBottom()},200))}),e(g).on("focusout",".sb-textarea",function(){setTimeout(()=>{l.removeClass("sb-header-hidden")},300)}),e(g).on("click",".sb-submit",function(){p.blur()}),window.addEventListener("popstate",function(){re.chat_open&&re.open(!1)})),e(h).on("click",".sb-menu li",function(){e(this).parent().sbActive(!1)}),e(g).on("click",".sb-submit",function(){re.submit()}),e("body").on("click",".sb-chat-btn,.sb-responsive-close-btn, #sb-open-chat, .sb-open-chat",function(){re.open(!re.chat_open)}),e(l).on("click",".sb-dashboard-btn",function(){re.showDashboard(),_.find(" > .sb-panel-articles > .sb-article").length&&re.showArticles(),i("open-conversation",0),G=!1}),e(l).on("click",".sb-user-conversations li",function(){re.openConversation(e(this).attr("data-conversation-id"))}),e(l).on("click",".sb-btn-new-conversation, .sb-departments-list > div, .sb-agents-list > div",function(){let t=e(this).data("id"),i=!1;if(!ie.null(t)){let n=e(this).parent().hasClass("sb-departments-list");if(n?re.default_department=parseInt(t):re.default_agent=parseInt(t),e(this).parent().data("force-one")){let e=a()?a().conversations:[];for(var s=0;s<e.length;s++)if(n&&e[s].get("department")==t||!n&&e[s].get("agent_id")==t){i=!0,re.openConversation(e[s].id);break}}}i||(G="new-conversation",re.clear(),re.hideDashboard())}),e(l).on("click",".sb-btn-all-conversations",function(){l.find(".sb-dashboard-conversations").removeClass("sb-conversations-hidden")}),e(g).on("click",".sb-btn-attachment",function(){re.is_busy||g.find(".sb-upload-files").val("").click()}),e(g).on("click",".sb-attachments > div > i",function(t){return e(this).parent().remove(),p.val()||0!=g.find(".sb-attachments > div").length||g.sbActive(!1),t.preventDefault(),!1}),e(g).on("change",".sb-upload-files",function(t){re.busy(!0),e(this).sbUploadFiles(function(e){re.uploadResponse(e)}),ie.event("SBAttachments")}),e(g).on("dragover",function(t){e(this).addClass("sb-drag"),clearTimeout(I),t.preventDefault(),t.stopPropagation()}),e(g).on("dragleave",function(t){I=setTimeout(()=>{e(this).removeClass("sb-drag")},200),t.preventDefault(),t.stopPropagation()}),e(g).on("drop",function(t){let i=t.originalEvent.dataTransfer.files;if(t.preventDefault(),t.stopPropagation(),i.length>0)for(var s=0;s<i.length;++s){let e=new FormData;e.append("file",i[s]),ie.upload(e,function(e){re.uploadResponse(e)})}return e(this).removeClass("sb-drag"),!1}),e(l).on("click",".sb-btn-all-articles:not([onclick])",function(){re.showArticles()}),e(l).on("click",".sb-articles > div",function(){re.showArticles(e(this).attr("data-id"),e(this).attr("data-is-category"))}),e(l).on("click",".sb-dashboard-articles .sb-input-btn .sb-submit-articles",function(){re.searchArticles(e(this).parent().find("input").val(),this,e(this).parent().next())}),e(c).on("click",".sb-article [data-rating]",function(){re.articleRatingOnClick(this)}),e(h).on("click",".sb-rich-button a",function(t){let i=e(this).attr("href");if(0===i.indexOf("#")&&0===i.indexOf("#article-"))return re.showArticles(i.replace("#article-","")),t.preventDefault(),!1}),e(b).on("click","[data-rating]",function(){let i=b.find("> div:last-child"),s=e(this).attr("data-rating"),n=re.conversation?re.conversation:a().getLastConversation(),o=n.getLastUserMessage(!1,!0);t(i),ie.ajax({function:"set-rating",conversation_id:n.id,agent_id:!!o&&o.get("user_id"),user_id:a().id,message:i.find("textarea").val(),rating:"positive"==s?1:-1},e=>{b.attr("data-close-chat")&&re.closeChat(),re.update(),b.sbActive(!1),i.sbLoading(!1)})}),e(c).on("click",".sb-lightbox-media > i",function(){return c.find(".sb-lightbox-media").sbActive(!1),$&&(SBAdmin.open_popup=!1),!1}),e(l).on("click",".sb-image",function(){ie.lightbox(e(this).html())}),e(l).on("click",".sb-slider-images .sb-card-img",function(){ie.lightbox(`<img loading="lazy" src="${e(this).attr("data-value")}" />`)}),e(document).on("SBConversationLoaded",function(){i("queue")&&re.queue(i("queue"))}),e(g).on("click",".sb-btn-emoji",function(){re.showEmoji(this)}),e(v).on("click",".sb-emoji-list li",function(t){re.insertEmoji(e(this).html()),q&&clearTimeout(I)}),e(v).find(".sb-emoji-list").on("touchend",function(e){I=setTimeout(()=>{re.mouseWheelEmoji(e)},50)}),e(v).find(".sb-emoji-list").on("mousewheel DOMMouseScroll",function(e){re.mouseWheelEmoji(e)}),e(v).find(".sb-emoji-list").on("touchstart",function(e){re.emoji_options.touch=e.originalEvent.touches[0].clientY}),e(v).on("click",".sb-emoji-bar > div",function(){re.clickEmojiBar(this)}),e(v).on("click",".sb-select li",function(){re.categoryEmoji(e(this).data("value"))}),e(v).find(".sb-search-btn input").on("change keyup paste",function(){re.searchEmoji(e(this).val())}),e(p).on("keyup",function(){re.textareaChange(this)}),e(l).on("click",".sb-privacy .sb-approve",function(){i("privacy-approved",!0),e(this).closest(".sb-privacy").remove(),l.removeClass("sb-init-form-active"),f.find(" > div").css({opacity:1,top:0}),re.initChat(),E?SBTickets.showPanel(ie.setting("tickets_disable_first")?"":"new-ticket"):re.isInitDashboard()||re.hideDashboard()}),e(l).on("click",".sb-privacy .sb-decline",function(){let t=e(this).closest(".sb-privacy");e(t).find(".sb-text").html(e(t).attr("data-decline")),e(t).find(".sb-decline").remove(),re.scrollBottom(!0)}),e(l).on("click",".sb-popup-message .sb-icon-close",function(){re.popup(!0)}),e(l).on("click",".sb-rich-message .sb-submit,.sb-rich-message:not(.sb-rich-registration) .sb-select ul li",function(){let t=e(this).closest(".sb-rich-message");t[0].hasAttribute("disabled")||le.submit(t,t.attr("data-type"),this)}),e(l).on("click",".sb-rich-message .sb-input > span",function(){e(this).sbActive(!0),e(this).siblings().focus()}),e(l).on("focus focusout click",".sb-rich-message .sb-input input,.sb-rich-message .sb-input select",function(t){switch(t.type){case"focusin":case"focus":e(this).siblings().sbActive(!0);break;case"focusout":e(this).val()?e(this).siblings().addClass("sb-filled sb-active"):setTimeout(()=>{K||e(this).siblings().sbActive(!1)},100);break;case"click":e(this).siblings().removeClass("sb-filled")}}),e(l).on("click",".sb-input-select-input > div",function(){K=!0,setTimeout(()=>{K=!1},250)}),e(l).on("click",".sb-slider-arrow",function(){le.sliderChange(e(this).closest("[id]").attr("id"),e(this).hasClass("sb-icon-arrow-right")?"right":"left")}),e(l).on("change",'.sb-rich-message [data-type="select"] select',function(){e(this).siblings().sbActive(!0)}),e(l).on("click",'[data-type="select-input"] > div',function(){e(this).prev().sbActive(!0),e(this).next().addClass("sb-focus")}),e(l).on("focusout",'[data-type="select-input"] input,[data-type="select-input"] select',function(){let t=e(this).closest(".sb-input");t.find("> input").val()+t.find("select").val()==""&&t.find("span").sbActive(!1),t.find(".sb-focus").removeClass("sb-focus")}),e(l).on("click",".sb-rich-registration .sb-login-area",function(){let t=l.hasClass("sb-init-form-active");e(this).closest(".sb-rich-registration").replaceWith(le.generate({},"login",t?"sb-init-form":"")),re.scrollBottom(t)}),e(l).on("click",".sb-rich-login .sb-registration-area",function(){if(P.registration_link)document.location=P.registration_link;else{let t=l.hasClass("sb-init-form-active");e(this).closest(".sb-rich-login").replaceWith(le.generate({},"registration",t?"sb-init-form":"")),re.scrollBottom(t)}}),e(l).on("click",".sb-rich-login .sb-submit-login",function(){ie.loginForm(this,!1,t=>{let i=e(this).closest(".sb-rich-login");if(a(new ae(t[0])),i.hasClass("sb-init-form"))G="open-conversation",re.initChat(),se.start(),re.isInitDashboard()||re.hideDashboard(),e(document).on("SBPopulateConversations",function(){l.removeClass("sb-init-form-active"),i.remove(),e(document).off("SBPopulateConversations")});else{i=i.closest("[data-id]");let e=re.conversation.getMessage(i.attr("data-id")),t=`${s("Logged in as")} *${a().name}*`;e.set("message",t),re.updateMessage(e.id,t),i.replaceWith(e.getCode()),se.started=!1,se.start()}})}),e(h).on("click",".sb-social-buttons div",function(){ie.openWindow(e(this).attr("data-link"))}),e(l).on("click",".sb-close-chat",function(){re.closeChat()}),e(h).on("click",'.sb-rich-woocommerce_button a, [href="#"].sb-card-btn',function(i){let s=ie.settingsStringToArray(e(this).closest(".sb-rich-message").attr("data-settings")),a="checkout"==s["link-type"]||s.checkout,n=e(this)[0].hasAttribute("data-ids")?e(this).attr("data-ids").split(","):[s.id.split("|")[e(this).parent().index()]];if(n.length){if(t(this))return;de.wordpress.ajax("button-purchase",{product_ids:n,checkout:a,coupon:s.coupon},t=>{a?document.location=t:e(this).addClass("sb-icon-check").sbLoading(!1)})}return i.preventDefault(),!1}),e(h).on("click","#sb-waiting-list .sb-submit",function(){0==e(this).index()&&setTimeout(()=>{de.woocommerce.waitingList("submit")},1e3)}),e(document).on("SBNewEmailAddress",function(e,t){"sb-waiting-list-email"==t.id&&de.woocommerce.waitingList("submit")}),e(h).on("click",".sb-player-btn",function(){let t=e(this).parent().find("audio").get(0),i=e(this).hasClass("sb-icon-play");h.find("audio").each(function(){e(this).get(0).pause(),e(this).unbind("ended"),e(this).parent().find(".sb-player-btn").removeClass("sb-icon-pause").addClass("sb-icon-play")}),i?(t.play(),e(this).removeClass("sb-icon-play")):t.pause(),e(t).unbind("ended"),e(t).bind("ended",()=>{e(this).removeClass("sb-icon-pause").addClass("sb-icon-play")}),e(this).addClass("sb-icon-"+(i?"pause":"play"))}),e(h).on("click",".sb-player-speed",function(){let t=e(this).parent();if(t.find(".sb-player-btn").hasClass("sb-icon-pause")){let i=e(this).find(".sb-player-speed-number"),s=parseFloat(i.html());(s+=.5)>2&&(s=1),t.find("audio").get(0).playbackRate=s,i.html(s)}}),e(h).on("click",".sb-player-download",function(){window.open(e(this).parent().find("audio source").attr("src"))}),e(g).on("click",".sb-btn-audio-clip",function(){if((k=re.conversation&&"wa"==re.conversation.get("source"))&&typeof SBAudioRecorder===W)return e.getScript(SB_URL+"/vendor/lame.min.js",()=>{this.click()},!0);navigator.mediaDevices.getUserMedia({audio:!0}).then(t=>{k?SBAudioRecorder.init(t):(typeof SBAudioRecorder!=W&&SBAudioRecorder.close(),X=[],(B=new MediaRecorder(t)).addEventListener("dataavailable",e=>{X.push(e.data)})),C||(C=g.find("#sb-audio-clip"),T=C.find(".sb-audio-clip-time"),C.on("click",".sb-btn-mic",function(){let t=e(this).hasClass("sb-icon-pause");if(t)k?SBAudioRecorder.pause():B.stop();else{let e=C.find(".sb-btn-clip-player");e.hasClass("sb-icon-pause")&&e.click(),k?SBAudioRecorder.resume():B.start()}Y[2]=!t,C.find(".sb-icon-play").sbActive(t),e(this).removeClass("sb-icon-"+(t?"pause":"mic")).addClass("sb-icon-"+(t?"mic":"pause"))}),C.on("click",".sb-btn-clip-player",function(){let t=e(this).hasClass("sb-icon-pause");if(t)Q[3].pause(),Q[2]=!1;else if(Q[3])Q[3].play(),Q[2]=!0;else{let t=new Audio(URL.createObjectURL(k?SBAudioRecorder.blob(!1):new Blob(X,{type:"audio/webm"})));T.html("0:00"),t.play(),t.onended=(()=>{Q[0]=0,Q[2]=!1,Q[3]=!1,T.html("0:00"),e(this).removeClass("sb-icon-pause").addClass("sb-icon-play")}),Q[0]=0,Q[2]=!0,Q[3]=t}e(this).removeClass("sb-icon-"+(t?"pause":"play")).addClass("sb-icon-"+(t?"play":"pause"))}),C.on("click",".sb-icon-close",function(){X=[],clearInterval(Y[1]),clearInterval(Q[1]),C.sbActive(!1),g.sbActive(!1).removeClass("sb-audio-message-active"),k?SBAudioRecorder.pause():B.stop(),x.getTracks()[0].stop()})),T.html("0:00"),x=t,clearInterval(Y[1]),clearInterval(Q[1]),Y=[0,setInterval(()=>{Y[2]&&(Y[0]++,T.html(o(Y[0])))},1e3),!0],Q=[0,setInterval(()=>{Q[2]&&(Q[0]++,T.html(o(Q[0])))},1e3),!1,!1],k||B.start(),C.find(".sb-btn-clip-player").removeClass("sb-icon-pause").addClass("sb-icon-play").sbActive(!1),C.find(".sb-icon-mic").removeClass("sb-icon-mic").addClass("sb-icon-pause"),C.sbActive(!0),p.val("").css("height",""),g.sbActive(!0).addClass("sb-audio-message-active")}).catch(e=>{alert(e)})}),e(h).on("click","[data-action].sb-rich-btn",function(t){return le.calendly.load(e(this).attr("data-extra"),e(this).html(),e(this).closest("[data-id]").attr("data-id")),t.preventDefault(),!1}),e(b).on("click","> div:first-child i",function(){l.find(".sb-overlay-panel").sbActive(!1),b.attr("data-close-chat")&&re.closeChat()}),e(l).on("change input","#phone > input",function(){let t=e(this).val().trim();if(/^[0-9+]+$/.test(t)||(t=t.replace(/[^0-9+]/g,""),e(this).val(t)),t.length>1&&0===t.indexOf("+")){let i=!1;"+1"==t.substring(0,2)&&(i=t.substring(0,2)),t.length>3&&(i=t.substring(0,3)),i&&(e(this).parent().find(`[data-value="${i}"]`).click(),e(this).parent().find(".sb-select").click(),e(this).val(t.replace(i,"")))}}),e(c).on("click",".sb-search-btn > i",function(){let t=e(this).parent(),i=e(t).sbActive();i&&(setTimeout(()=>{e(t).find("input").val("")},50),setTimeout(()=>{e(t).find("input").trigger("change")},550)),e(t).sbActive(!i),e(t).find("input").get(0).focus(),c.find(".sb-select ul").sbActive(!1)}),e(c).on("click",".sb-select",function(t){if(!t.target||!e(t.target).is("input")){let t=e(this).find("ul"),i=t.hasClass("sb-active");e(c).find(".sb-select ul").sbActive(!1),t.setClass("sb-active",!i),e(this).find(".sb-select-search").setClass("sb-active",!i),$&&(SBAdmin.open_popup=!i&&this)}}),e(c).on("click",".sb-select li",function(){let t=e(this).closest(".sb-select"),i=e(this).data("value"),s=e(t).find(`[data-value="${i}"]`);t.find("li").sbActive(!1),t.find("p").attr("data-value",i).html(e(s).html()),s.sbActive(!0)}),e(c).on("input",".sb-select-search input",function(t){let i=e(this).val();ie.search(i,()=>{let t=e(this).parent().parent().find("li");t.setClass("sb-hide",i.length),i.length&&(i=i.toLowerCase(),t.each(function(){(e(this).attr("data-value").includes(i)||e(this).attr("data-country").includes(i))&&e(this).removeClass("sb-hide")}))})}),e(c).on("click",".sb-input-image .image",function(){d=e(this).parent(),g.find(".sb-upload-files").click()}),e(c).on("click",".sb-input-image .image > .sb-icon-close",function(t){return ie.ajax({function:"delete-file",path:e(this).parent().attr("data-value")}),e(this).parent().removeAttr("data-value").css("background-image",""),t.preventDefault(),!1})}var l,c,d,u,h,g,p,f,m,v,_,b,y,w,S,A,k,C,T,B,x,$=!1,E=!1,I=!1,L=!1,R=[!1,!1],j=!1,M=[],N=!1,D=!1,U=[9999999,""],O=document.title,P={},q=e(window).width()<465,G="",F=!1,W="undefined",z=!0,V=6e4*(new Date).getTimezoneOffset(),H=!1,J=!1,X=[],Y=[0,!1],Q=[0,!1],K=!1,Z=!1,ee=0,te=typeof Shopify!==W;e.fn.extend({manualExpandTextarea:function(){var t=this[0];t.style.height="auto",t.style.maxHeight="25px",window.getComputedStyle(t),t.style.height=(t.scrollHeight>350?350:t.scrollHeight)+"px",t.style.maxHeight="",e(t).trigger("textareaChanged")},autoExpandTextarea:function(){var t=this[0];t.addEventListener("input",function(i){e(t).manualExpandTextarea()},!1)}}),function(){var e=[].slice;String.prototype.autoLink=function(){var t,i,s,a,n,o,r;return o=/(^||[\s\n]|<[A-Za-z]*\/?>)((?:https?|ftp):\/\/[\-A-Z0-9+\u0026\u2019@#\/%?=()~_|!:,.;]*[\-A-Z0-9+\u0026@#\/%=~_|])/gi,0<(n=1<=arguments.length?e.call(arguments,0):[]).length?(a=n[0],t=a.callback,s=function(){var e;for(i in e=[],a)r=a[i],"callback"!==i&&e.push(" "+i+"='"+r+"'");return e}().join(""),this.replace(o,function(e,i,a){return""+i+(("function"==typeof t?t(a):void 0)||"<a href='"+a+"'"+s+">"+a+"</a>")})):this.replace(o,"$1<a href='$2'>$2</a>")}}.call(this);var ie={visibility_status:"visible",ajax:function(t,i=!1){A?(A[0].push(t),A[1].push(i)):(A=[[t],[i]],setTimeout(()=>{let s=A[1],n={"login-cookie":ie.loginCookie()};a()&&(n.user_id=a().id),typeof SB_LANG!=W&&(n.language=SB_LANG),H&&(n.cloud=H),location.search.includes("debug")&&(n.debug=!0),e.ajax({method:"POST",url:SB_AJAX_URL,data:e.extend({function:"ajax_calls",calls:A[0]},n)}).done(e=>{let a;if(Array.isArray(e))a=e;else if("invalid-session"===e)setTimeout(()=>{ie.reset()},1e3);else{if($&&SB_ADMIN_SETTINGS.cloud&&e.includes("no-credits"))return SBCloud.creditsAlertQuota();try{a="string"==typeof e||e instanceof String?JSON.parse(e):e}catch(i){return void this.ajax_error(e,t)}}for(var n=0;n<a.length;n++){let e=a[n];if(Array.isArray(e)||(e=a),"success"==e[0])(i=s[n])&&i(e[1]);else if(ie.errorValidation(e))i&&i(e);else{$&&("security-error"==e[1]&&setTimeout(()=>{ie.reset()},1e3),SBAdmin.conversations.busy=!1),re.is_busy_update=!1,re.busy(!1);let i=JSON.parse(e);Array.isArray(i)&&"error"==i[0]&&i[2]&&i[3]?ie.error(i[3],i[2]):ie.error(JSON.stringify(e).replace(/\\/g,"").replace(/\"/g,"").replace(/\[/g,"").replace(/\]/g,"").replace("error,",""),t.function)}}}).fail((e,t,i)=>{this.ajax_error("HTTP CURL ERROR"),console.log(i)}),A=!1},100))},ajax_error:function(e,t=!1){$&&(SBAdmin.conversations.busy=!1,de.dialogflow.smart_reply_busy=!1),de.dialogflow.busy&&(de.dialogflow.busy=!1,!$&&re.conversation&&(ie.ajax({function:"open-ai-send-fallback-message",conversation_id:re.conversation.id}),re.typing(-1,"stop"))),re.is_busy_update=!1,re.busy(!1),console.log(e),ie.error(e.length>500?e.substr(0,500)+"... Check the console for more details.":e,`SBF.ajax.${t?t.function:""}`)},cors:function(e="GET",t,i){let s=new XMLHttpRequest;if("withCredentials"in s)s.open(e,t,!0);else{if(typeof XDomainRequest==W)return!1;(s=new XDomainRequest).open(e,t)}s.onload=function(){i(s.responseText)},s.onerror=function(){return!1},s.send()},upload:function(e,t){H&&e.append("cloud",H),jQuery.ajax({url:SB_URL+"/include/upload.php",cache:!1,contentType:!1,processData:!1,data:e,type:"POST",success:function(e){t(e)}})},getFileType:function(e){return/.jpg|.jpeg|.png|.gif|.webp/.test(e)?"image":/.mp3|.ogg|.wav|.aac/.test(e)?"audio":/.mp4|.mkv|.vob|.3gp|.webm/.test(e)?"video":"file"},UTC:function(e){return new Date(e).getTime()-V},null:function(e){return typeof e===W||null===e||"null"===e||!1===e||!(e.length>0||"number"==typeof e||typeof e.length==W)||e===W},deactivateAll:function(){c.find(".sb-popup, .sb-tooltip, .sb-list .sb-menu, .sb-select ul").sbActive(!1)},deselectAll:function(){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty()},getURL:function(e=!1,t=!1){if(t||(t=location.search),0==e){for(var i=t.split("?").pop().split("&"),s={},a=0;a<i.length;a++){var n=i[a].split("=");s[n[0]]=ie.escape(n[1])}return s}return t.indexOf("?")>0&&(t=t.substr(0,t.indexOf("?"))),ie.escape(decodeURIComponent((new RegExp("[?|&]"+e+"=([^&;]+?)(&|#|;|$)").exec(t)||[,""])[1].replace(/\+/g,"%20")||""))},URL:function(){return window.location.href.substr(0,window.location.href.indexOf("?"))},stringToSlug:function(e){e=(e=e.trim()).toLowerCase();for(var t="åàáãäâèéëêìíïîòóöôùúüûñç·/_,:;",i=0,s=t.length;i<s;i++)e=e.replace(new RegExp(t.charAt(i),"g"),"aaaaaaeeeeiiiioooouuuunc------".charAt(i));return e.replace(/[^a-z0-9 -]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").replace(/^-+/,"").replace(/-+$/,"").replace(/ /g,"")},slugToString:function(e){return(e=e.replace(/_/g," ").replace(/-/g," ")).charAt(0).toUpperCase()+e.slice(1)},random:function(){let e="";for(var t=5;t>0;--t)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return e},isAgent:function(e){return"agent"==e||"admin"==e||"bot"==e},beautifyTime:function(e,t=!1,i=!1){let a;if("0000-00-00 00:00:00"==e)return"";if(e.indexOf("-")>0){let t=e.split(/[- :]/);a=new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])}else{let t=e.split(/[. :]/);a=new Date(t[2],t[1]-1,t[0],t[3],t[4],t[5])}let n=new Date,o=new Date(Date.UTC(a.getFullYear(),a.getMonth(),a.getDate(),a.getHours(),a.getMinutes(),a.getSeconds())),r=(n-o)/864e5*(i?-1:1),l=[s("Sunday"),s("Monday"),s("Tuesday"),s("Wednesday"),s("Thursday"),s("Friday"),s("Saturday")],c=o.toLocaleTimeString(navigator.language,{hour:"2-digit",minute:"2-digit"});return"0"===c.charAt(0)&&(c.includes("PM")||c.includes("AM"))&&(c=c.substring(1)),r<1&&n.getDate()==o.getDate()?t?`<span>${s("Today")}</span> <span>${c}</span>`:`<span data-today>${c}</span>`:r<7?`<span>${l[o.getDay()]}</span>${t?` <span>${c}</span>`:""}`:`<span>${o.toLocaleDateString()}</span>${t?` <span>${c}</span>`:""}`},unix:function(e){let t=e.split(/[- :]/);return Date.UTC(t[0],t[1]-1,t[2],t[3],t[4],t[5])},getLocationTimeString:function(e,t){if(e.timezone){let i={};i.timezone=e.timezone.value,i.country=e.country?e.country.value:i.timezone.split("/")[0].replace(/_/g," "),i.city=e.city?e.city.value:i.timezone.split("/")[1].replace(/_/g," "),ie.cors("GET","https://worldtimeapi.org/api/timezone/"+i.timezone,function(e){if(e=JSON.parse(e),ie.null(e)||e.error)ie.error(e,"SBF.getLocationTimeString()"),t(responseonSuccess);else{let a=e.datetime.replace("T"," ");t(`${new Date(a.substr(0,a.indexOf("."))).toLocaleString([],{hour:"2-digit",minute:"2-digit"})} ${s("in")} ${i.city?i.city:""}${i.country?", "+i.country:""}`)}})}},dateDB:function(e){return"now"==e?((e=(new Date).toISOString().replace("T"," ")).indexOf(".")>0&&(e=e.substr(0,e.indexOf("."))),e):`${e.getFullYear()}-${e.getMonth()+1}-${e.getDate()} ${e.getHours()}:${e.getMinutes()}:${e.getSeconds()}`},updateUsersActivity:function(e,t,i){se.active?i($&&SB_ADMIN_SETTINGS.bot_id==t||!$&&P.bot_id==t?"online":se.online_ids.includes(t)?"online":"offline"):ie.ajax({function:"update-users-last-activity",user_id:e,return_user_id:t,check_slack:!$&&P.slack_active},e=>{i("online"===e?"online":"offline")})},search:function(e,t){(e=e.toLowerCase())!=u?(clearTimeout(I),I=setTimeout(function(){u=e,t()},1e3)):c.find(".sb-search-btn i").sbLoading(!1)},searchClear:function(t,i){e(t).next().val()&&(e(t).next().val(""),i())},error:function(e,t){let i=e.includes(t);if(!$||!SBAdmin.is_logout)throw e instanceof Error&&(e=e.message),"."==e[e.length-1]&&(e=e.slice(0,-1)),$&&(!e||t.includes("update-users-last-activity")||t.startsWith("security-error")||SBAdmin.infoPanel(`<pre>${i?"":`[Error] [${t}] `}${e}. Check the console for more details.</pre>`,"info",!1,"error"),de.dialogflow.smart_reply_busy=!1),c.find(".sb-loading").sbLoading(!1),re.busy(!1),ie.event("SBError",{message:e,function_name:t}),new Error(i?e:`Support Board Error [${t}]: ${e}.`)},errorValidation:function(e,t=!0){return Array.isArray(e)&&"validation-error"===e[0]&&(!0===t||e[1]==t)},loginForm:function(t,i=!1,a=!1){if(!(t=e(t)).sbLoading()){i=!1===i?t.closest(".sb-rich-login"):e(i);let n=e.trim(i.find("#email input").val()),o=e.trim(i.find("#password input").val());n&&o?(ie.ajax({function:"login",email:n,password:o},e=>{if(e&&Array.isArray(e)){if(!$&&this.isAgent(e[0].user_type))ce.showErrorMessage(i,"You cannot sign in as an agent."),re.scrollBottom();else{let t=new ae(e[0]);t.set("conversation_id",!!re.conversation&&re.conversation.id),this.loginCookie(e[1]),this.event("SBLoginForm",t),a&&a(e)}"wp"==ie.setting("wp-users-system")&&de.wordpress.ajax("wp-login",{user:n,password:o})}else i.find(".sb-info").html(s("ip-ban"===e?"Too many login attempts. Please retry again in a few hours.":"Invalid email or password.")).sbActive(!0),$||re.scrollBottom();t.sbLoading(!1)}),i.find(".sb-info").html("").sbActive(!1),t.sbLoading(!0)):(i.find(".sb-info").html(s("Please insert email and password.")).sbActive(!0),re.scrollBottom())}},loginCookie:function(e=!1){if(!1===e)return this.cookie("sb-login")?this.cookie("sb-login"):i("login");P.cloud?i("login",e):this.cookie("sb-login",e,3650,"set")},login:function(e="",t="",i="",s="",a=!1){ie.ajax({function:"login",email:e,password:t,user_id:i,token:s},e=>!(0==e||!Array.isArray(e))&&(this.loginCookie(e[1]),a&&a(e),!0))},logout:function(e=!0){re.stopRealTime(),this.cookie("sb-login","","",!1),this.cookie("sb-cloud","","",!1),i("open-conversation",""),i("login",""),re.conversations=!1,a(!1),typeof sb_beams_client!==W&&sb_beams_client.stop(),typeof SB_AJAX_URL!==W&&ie.ajax({function:"logout"},()=>{ie.event("SBLogout"),e&&setTimeout(()=>{location.reload()},500)})},activeUser:function(){return a()},getActiveUser:function(e=!1,t){let s=de.login();!s&&(i("wp-login")||i("whmcs-login")||i("perfex-login")||i("aecommerce-login"))&&(this.cookie("sb-login","","","delete"),a(!1),i("login",""),i("wp-login",""),i("whmcs-login",""),i("perfex-login",""),i("aecommerce-login","")),ie.ajax({function:"get-active-user",db:e,login_app:JSON.stringify(s),user_token:ie.getURL("token")},e=>{if(!e)return t(),!1;if(e.cookie&&ie.loginCookie(e.cookie),e.user_type)if(!$&&ie.isAgent(e.user_type)){let e="You are logged in as both agent and user. Logout or use another browser, Incognito or Private mode, to login as user. Force a logout by running the function SBF.reset() in the console.";i("double-login-alert")||(i("double-login-alert",!0),alert(e)),console.warn("Support Board: "+e),ie.event("SBDoubleLoginError")}else a(new ae(e,e.phone?{phone:e.phone}:{})),se.start(),s&&i(s[1]+"-login",!0),t(),ie.event("SBActiveUserLoaded",e)})},reset:function(){let e=["sb-login","sb-cloud","sb-dialogflow-disabled"];for(var t=0;t<e.length;t++)this.cookie(e[t],"",0,!1);try{localStorage.removeItem("support-board")}catch(e){}this.logout()},lightbox:function(t){let i=e($?c:l).find(".sb-lightbox-media");i.sbActive(!0).find(" > div").html(t),$&&(SBAdmin.open_popup=i)},storage:function(e,t=W){try{if(typeof localStorage==W)return!1}catch(e){return!1}let i=localStorage.getItem("support-board");if(i=null===i?{}:JSON.parse(i),t===W)return e in i&&i[e];t?i[e]=t:delete i[e],localStorage.setItem("support-board",JSON.stringify(i))},storageTime:function(e,t=!1){let s=new Date;if(!1!==t)return 0==i(e)||s.getTime()-i(e)>36e5*t&&(i(e,!1),!0);i(e,s.getTime())},cookie:function(e,t=!1,i=!1,s="get",a=!1){let n="https:"==location.protocol?"SameSite=None;Secure;":"",o=window[$?"SB_ADMIN_SETTINGS":"CHAT_SETTINGS"],r=o&&o.cookie_domain?"domain="+o.cookie_domain+";":"";if("get"==s){if(!z)return this.storage(e);let t=document.cookie.split(";");for(var l=0;l<t.length;l++){for(var c=t[l];" "==c.charAt(0);)c=c.substring(1);if(0==c.indexOf(e)){let t=c.substring(e.length+1,c.length);return!this.null(t)&&t}}return!1}if("set"==s)if(z){let s=new Date;s.setTime(s.getTime()+i*(a?1:86400)*1e3),document.cookie=e+"="+t+";expires="+s.toUTCString()+";path=/;"+n+r}else this.storage(e,t);else this.cookie(e)&&(z?document.cookie=e+"="+t+";expires=Thu, 01 Jan 1970 00:00:01 GMT;path=/;"+n+r:this.storage(e,""))},setting:function(e,t=-1){if(-1===t)return typeof P!==W&&e in P&&P[e];typeof P!==W&&(P[e]=t)},shortcode:function(e){return le.shortcode(e)},event:function(t,i){e(document).trigger(t,i);let s=$?typeof SB_ADMIN_SETTINGS!==W&&SB_ADMIN_SETTINGS.webhooks:P.webhooks,a={SBGetUser:"get-user",SBSMSSent:"sms-sent",SBLoginForm:"login",SBRegistrationForm:"registration",SBUserDeleted:"user-deleted",SBNewMessagesReceived:"new-messages",SBNewConversationReceived:"new-conversation",SBSlackMessageSent:"slack-message-sent",SBMessageDeleted:"message-deleted",SBRichMessageSubmit:"rich-message",SBNewEmailAddress:"new-email-address"};if(s&&t in a){if(!0!==s&&(Array.isArray(s)||(s=s.replace(/ /g,"").split(",")),!s.includes(a[t])))return;ie.ajax({function:"webhooks",function_name:t,parameters:i})}},translate:function(e){if(!$&&ie.null(P)||$&&typeof SB_TRANSLATIONS===W)return e;let t=$?SB_TRANSLATIONS:P.translations;return t&&t[e]&&t[e]?t[e]:e},escape:function(e){return e?e.replace(/</gi,"&lt;").replace(/javascript:|onclick|onerror|ontoggle|onmouseover|onload|oncontextmenu|ondblclick|onmousedown|onmouseenter|onmouseleave|onmousemove|onmouseout|onmouseup/gi,""):""},strip:function(e){e=e.replace("```","");let t=[/\*([^\**]+)\*/,/\__([^\____]+)\__/,/\~([^\~~]+)\~/,/\`([^\``]+)\`/];for(var i=0;i<2;i++)t.forEach(t=>{e=e.replace(t,e=>e.replace(/[\*\_\~\`]/g,""))});return e.replace(/\\,/g,",").replace(/\\:/g,":")},visibilityChange:function(e=""){this.visibility_status=e;let t=$&&typeof SBAdmin!==W;"hidden"==e?($||re.stopRealTime(),re.tab_active=!1,this.visibility_was_hidden=!0):(a()&&!$&&re.startRealTime(),re.tab_active=!0,clearInterval(j),clearInterval(re.audio_interval),re.conversation&&(re.conversation.updateMessagesStatus(),(re.chat_open||$)&&re.updateNotifications(re.conversation.id),t&&setTimeout(()=>{SBAdmin.conversations.notificationsCounterReset(re.conversation.id)},2e3)),t&&(Date.now()-(q?6e4:18e4)>ee&&(SBAdmin.conversations.update(),ee=Date.now()),q&&re.update()),document.title=O,this.serviceWorker.closeNotifications())},settingsStringToArray:function(e){if(this.null(e))return[];let t=[];e=e.split(",");for(var i=0;i<e.length;i++){let s=e[i].split(":");t[s[0]]="false"!=s[1]&&("true"==s[1]||s[1])}return t},openWindow:function(e,t=550,i=350){let s=screen.width/2-t/2,a=screen.height/2-i/2;return window.open(e,"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width="+t+",height="+i+", top="+a+", left="+s),!1},convertUTCDateToLocalDate:function(e,t=0){return e=new Date(e),e=new Date(e.getTime()+36e5*t),new Date(e.getTime()+-1*V)},loadResource:function(e,t=!1,i=!1,s=!1){let a=document.createElement(t?"script":"link");e?(t?a.src=e:a.href=e,a.type=t?"text/javascript":"text/css"):a.innerHTML=s,i&&(a.onload=function(){i()}),t||(a.rel="stylesheet"),document.head.appendChild(a)},debounce:function(e,t,i=500){t in M||(M[t]=!0,e(),setTimeout(()=>{delete M[t]},i))},serviceWorker:{sw:!1,timeout:!1,init:function(){navigator.serviceWorker&&navigator.serviceWorker.register($||"undefined"!=typeof SB_CLOUD_SW?SB_URL.replace("/script","")+"/sw.js?v=3.7.8":P.push_notifications_url+"?v=3.7.8").then(e=>{e.update(),this.sw=e}).catch(function(e){console.warn(e)})},initPushNotifications:function(){$&&("pusher"==SB_ADMIN_SETTINGS.push_notifications_provider||"onesignal"!=SB_ADMIN_SETTINGS.push_notifications_provider)||!$&&("pusher"==P.push_notifications_provider||"pushalert"!=P.push_notifications_provider)?se.initPushNotifications():e.getScript("https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js",()=>{window.OneSignalDeferred=window.OneSignalDeferred||[],OneSignalDeferred.push(e=>{e.init({appId:SB_ADMIN_SETTINGS.push_notifications_id})}),OneSignalDeferred.push(e=>{e.User.PushSubscription.addEventListener("change",t=>{if(t.current.optedIn){let t=($&&SB_ADMIN_SETTINGS.cloud?SB_ADMIN_SETTINGS.cloud.cloud_user_id+"-":!$&&P.cloud?P.cloud.cloud_user_id+"-":"")+($?SB_ACTIVE_AGENT.id:a().id);1==t&&(t="SB-1"),e.User.addTag("user_type",$?"agents":"users"),e.login(t)}ie.event("SBPushNotificationSubscription",t.current)})}),Z=!1})},closeNotifications:function(e=0){this.sw&&this.sw.getNotifications().then(t=>{if(t.length)for(let e=0;e<t.length;e+=1)t[e].close();else e<300&&"visible"==ie.visibility_status&&setTimeout(()=>{this.closeNotifications(e+1)},10)})},pushNotification:function(e,t=!1){let i=$?SB_ACTIVE_AGENT.profile_image:a().image;ie.ajax({function:"push-notification",title:$?SB_ACTIVE_AGENT.full_name:a().name,message:ie.strip(e),icon:i.indexOf("user.svg")>0?P.notifications_icon:i,interests:t||re.getRecipientUserID(),conversation_id:!!re.conversation&&re.conversation.id},e=>e)}},beautifyAttachmentName:function(e){let t=e.indexOf("_");return-1!==t?e.substring(t+1):e}},se={channels:{},channels_presence:[],active:!1,pusher:!1,started:!1,pusher_beams:!1,initialized:!1,online_ids:[],beams_loaded:!1,init:function(t=!1){if(se.active){if(this.pusher)return!t||t();if(!t)return;e(window).one("SBPusherInit",()=>{t()}),this.initialized=!0,typeof Pusher===W?e.getScript("https://js.pusher.com/8.2.0/pusher.min.js",()=>{window.Pusher=Pusher,this.init_2()},!0):this.init_2()}},init_2:function(){this.pusher=new Pusher($?SB_ADMIN_SETTINGS.pusher_key:P.pusher_key,{cluster:$?SB_ADMIN_SETTINGS.pusher_cluster:P.pusher_cluster,channelAuthorization:{endpoint:SB_URL+"/include/pusher.php",params:{login:ie.loginCookie(),cloud_user_id:!!P.cloud&&P.cloud.cloud_user_id}}}),ie.event("SBPusherInit")},initPushNotifications:function(){(a()||$)&&(this.beams_loaded?this.initPushNotifications_2():e.getScript("https://js.pusher.com/beams/2.0.0-beta.0/push-notifications-cdn.js",()=>{this.initPushNotifications_2()},!0))},initPushNotifications_2:function(){window.navigator.serviceWorker.ready.then(e=>{this.pusher_beams=new PusherPushNotifications.Client({instanceId:$?SB_ADMIN_SETTINGS.push_notifications_id:P.push_notifications_id,serviceWorkerRegistration:e}),ie.serviceWorker.closeNotifications(),this.pusher_beams.start().then(()=>this.pusher_beams.setDeviceInterests($?[SB_ACTIVE_AGENT.id,"agents"]:[a().id,"users"])).catch(console.error),Z=!1})},start:function(){$||this.started||!a()||(this.active&&this.init(()=>{this.event("client-typing",e=>{e.user_id==re.agent_id&&re.conversation&&e.conversation_id==re.conversation.id&&(re.typing(-1,"start"),clearTimeout(L),L=setTimeout(()=>{re.typing(-1,"stop")},1e3))}),this.event("new-message",e=>{!(e&&a()&&e.conversation_id)||a().getConversationByID(e.conversation_id)&&re.conversation&&re.conversation.id==e.conversation_id?re.update():re.updateConversations()}),this.presence(1,()=>{this.started=!0,re.automations.runAll()})}),P.push_notifications_users&&("pusher"!=P.push_notifications_provider&&"onesignal"==P.push_notifications_provider||(typeof Notification!=W&&"granted"==Notification.permission?this.initPushNotifications():Z=!0)))},subscribe:function(e,t=!1){if(!this.pusher)return this.init(()=>{this.subscribe(e,t)});e=this.cloudChannelRename(e);let i=this.pusher.subscribe(e);i.bind("pusher:subscription_error",e=>console.log(e)),i.bind("pusher:subscription_succeeded",()=>{this.channels[e]=i,t&&t()})},event:function(e,t,i="private-user-"+a().id){if(!this.pusher)return this.init(()=>{this.event(e,t,i)});let s=i;(i=this.cloudChannelRename(i))in this.channels?(this.channels[i].unbind(e),this.channels[i].bind(e,e=>{t(e)})):this.subscribe(s,()=>{this.event(e,t,s)})},trigger:function(e,t={},i="private-user-"+a().id){if(0==e.indexOf("client-"))return this.channels[this.cloudChannelRename(i)].trigger(e,t);ie.ajax({function:"pusher-trigger",channel:i,event:e,data:t},e=>e)},presence:function(e=1,t){if(!this.pusher)return this.init(()=>{this.presence()});let i=this.pusher.subscribe(this.cloudChannelRename("presence-"+e));i.bind("pusher:subscription_succeeded",i=>{if(i.count>98)return this.subscribe(e+1);i.each(e=>{this.presenceCheck(e)&&this.online_ids.push(e.id)}),re.updateUsersActivity(),t&&t()}),i.bind("pusher:subscription_error",e=>console.log(e)),i.bind("pusher:member_added",e=>{this.presenceCheck(e)&&this.presenceAdd(e.id),$&&ie.storageTime("online-user-notification-"+e.id,24)&&(SBAdmin.users.onlineUserNotification(e),ie.storageTime("online-user-notification-"+e.id))}),i.bind("pusher:member_removed",e=>{this.presenceRemove(e.id)}),this.channels_presence.push(i),!$&&P.slack_active&&(this.event("add-user-presence",e=>{this.presenceAdd(e.agent_id)}),ie.ajax({function:"slack-presence",list:!0},e=>{for(var t=0;t<e.length;t++)this.presenceAdd(e[t]);re.updateUsersActivity()}))},presenceCheck:function(e){let t=ie.isAgent(e.info.user_type);return($&&!t||!$&&t)&&!this.online_ids.includes(e.id)},presenceAdd:function(e){typeof e==W||this.online_ids.includes(e)||(this.online_ids.push(e),this.presenceUpdateAdmin(e),re.updateUsersActivity())},presenceRemove:function(e){if(typeof e==W)return;let t=this.online_ids.indexOf(e);-1!==t?(this.online_ids.splice(t,1),this.presenceUpdateAdmin(e),re.updateUsersActivity()):$&&c.find(`.sb-conversation-busy[data-agent="${e}"]`).remove()},presenceUnsubscribe:function(){for(var e=0;e<this.channels_presence.length;e++)this.channels_presence[e].unsubscribe(this.cloudChannelRename("presence-"+(e+1)))},presenceUpdateAdmin:function(e){$&&(c.find(".sb-area-users.sb-active").length&&SBAdmin.users.update(),a()&&a().id==e&&SBAdmin.users.updateUsersActivity())},cloudChannelRename:function(e){return P.cloud||$&&SB_ADMIN_SETTINGS.cloud?e+"-"+($?SB_ADMIN_SETTINGS.cloud.cloud_user_id:P.cloud.cloud_user_id):e}};window.SBF=ie,window.SBPusher=se,window.sb_current_user=!1,e.fn.sbActive=function(t=-1){return-1===t?e(this).hasClass("sb-active"):(e(this).setClass("sb-active",t),this)},e.fn.sbLoading=function(t="check"){return"check"==t?e(this).hasClass("sb-loading"):(e(this).setClass("sb-loading",t),this)},e.fn.sbTogglePopup=function(t=!1){let i=!0;return $&&(SBAdmin.open_popup=!1),e(this).sbActive()?(e(this).sbActive(!1),c.removeClass("sb-popup-active"),i=!1):(c.addClass("sb-popup-active"),c.find(".sb-popup").sbActive(!1),t&&e(this).css("left",e(t).offset().left+15).sbActive(!0),$&&setTimeout(()=>{SBAdmin.open_popup=this},500),ie.deselectAll()),i},e.fn.sbUploadFiles=function(t,i=!1){let a=e(this).prop("files");for(var n=!1===i?0:i;n<(!1===i?a.length:i+1);n++){let e=a[n],i=e.size/1048576,o=$?SB_ADMIN_SETTINGS.max_file_size:P.max_file_size;if(i>o){let e=s("Maximum upload size is {R}MB. File size: {R2}MB.").replace("{R}",o).replace("{R2}",i.toFixed(2));$?SBAdmin.infoPanel(e,"info"):alert(e)}let r=new FormData;r.append("file",e),ie.upload(r,t)}e(this).value=""},e.fn.setProfile=function(t=!1,i=!1){return ie.null(t)&&(t=a()?a().name:""),ie.null(i)&&(i=a()?a().image:SB_URL+"/media/user.svg"),t&&e(this).removeClass("sb-profile-empty"),e(this).find("img").attr("src",i),e(this).find(".sb-name").html(t),this},e.fn.setClass=function(t,i=!0){return i?e(this).addClass(t):e(this).removeClass(t),this};class ae{constructor(e={},t={}){this.details=e,this.extra=t,this.conversations=[],this.processArray(e)}get id(){return this.get("id")?this.get("id"):this.get("user_id")}get type(){return this.get("user_type")}get email(){return this.get("email")}get name(){return this.details.first_name?this.details.first_name+(this.details.last_name?" "+this.details.last_name:""):""}get nameBeautified(){let e=$?SB_ADMIN_SETTINGS.visitor_default_name:P.visitor_default_name;return!e||this.details.last_name&&"#"!=this.details.last_name.charAt(0)?this.name:e}get image(){return this.get("profile_image")}get language(){let e=this.getExtra("language");return e||(e=this.getExtra("browser_language")),e?e.value.toLowerCase():""}get(e){return e in this.details&&!ie.null(this.details[e])?this.details[e]:""}getExtra(e){return e in this.extra&&!ie.null(this.extra[e])?this.extra[e]:""}set(e,t){this.details[e]=t}setExtra(e,t){this.extra[e]=t}processArray(e){if(e&&e.details){for(var t=0;t<e.details.length;t++)this.setExtra(e.details[t].slug,e.details[t]);delete e.details,this.details=e}}update(e){this.id?ie.ajax({function:"get-user",user_id:this.id,extra:!0},t=>{this.processArray(t),e(),ie.event("SBGetUser",this)}):ie.error("Missing user ID","SBUser.update")}getConversations(e=!1,t){this.id?ie.ajax({function:"get-user-conversations",user_id:this.id,exclude_id:t,agent:ie.isAgent(this.type)},t=>{if(!ie.errorValidation(t)){let s=[];for(var i=0;i<t.length;i++)re.isConversationAllowed(t[i].source,t[i].conversation_status_code)&&s.push(new oe([new ne(t[i])],t[i]));this.conversations=s,e&&e(s)}}):ie.error("Missing user ID","SBUser.getConversations")}getConversationsCode(e=!1){let t="",i=re.conversation?re.conversation.id:-1;e||(e=this.conversations);for(var s=0;s<e.length;s++)if(e[s]instanceof oe){if(!$&&!re.isConversationAllowed(e[s].get("source"),e[s].status_code))continue;let n=0,o=i==e[s].id;if(!$&&!o)for(var a=0;a<re.notifications.length;a++)re.notifications[a][0]==e[s].id&&n++;t+=`<li ${o?'class="sb-active" ':""}data-conversation-status="${o?0:e[s].status_code}" data-conversation-id="${e[s].id}" data-department="${e[s].get("department")}">${e[s].getCode()}${n?'<span data-count="'+n+'">'+n+"</span>":""}</li>`}else ie.error("Conversation not of type SBConversation","SBUser.getConversationsCode");return t}getFullConversation(e=!1,t=!1){!1!==e?ie.ajax({function:"get-conversation",conversation_id:e},e=>{let i=[];if(e){if("agent-not-authorized"===e)return void(window.location.href=ie.URL());for(var s=0;s<e.messages.length;s++)i.push(new ne(e.messages[s]))}t&&t(new oe(i,!!e&&e.details))}):ie.error("Missing conversation ID","SBUser.getFullConversation")}getConversationByID(e,t=!1){for(var i=0;i<this.conversations.length;i++)if(this.conversations[i].id==e)return t?i:this.conversations[i];return!1}addConversation(e){if(e instanceof oe){let i=e.id,s=!0;for(var t=0;t<this.conversations.length;t++)if(this.conversations[t].id==i){this.conversations[t]=e,s=!1;break}return s&&this.conversations.unshift(e),s}ie.error("Conversation not of type SBConversation","SBUser.addConversation")}removeConversation(e){let t=this.getConversationByID(e,!0);!1!==t&&this.conversations.splice(t,1)}getLastConversation(){return!this.isConversationsEmpty()&&this.conversations[this.conversations.length-1]}isConversationsEmpty(){return 0==this.conversations.length}isExtraEmpty(){return 0===Object.keys(this.extra).length&&this.extra.constructor===Object}delete(e){this.id?ie.ajax({function:"delete-user",user_id:this.id},()=>(ie.event("SBUserDeleted",this.id),e(),!0)):ie.error("Missing user ID","SBUser.delete")}}window.SBUser=ae;class ne{constructor(e={}){this.details=Object.assign({},e);let t=["message_status_code","message_id","message_profile_image","message_first_name","message_last_name","message_user_id","message_user_type"],i=["source","extra","title","tags","agent_id","department","last_update_time","conversation_creation_time","conversation_id","conversation_status_code","conversation_user_id"];for(s=0;s<t.length;s++)e[t[s]]&&(this.details[t[s].replace("message_","")]=e[t[s]]),delete this.details[t[s]];this.details.first_name&&(this.details.full_name=this.details.first_name+(this.details.last_name?" "+this.details.last_name:"")),e.last_update_time&&(this.details.creation_time=e.last_update_time);for(var s=0;s<i.length;s++)delete this.details[i[s]];let a=this.get("payload");if(a)try{var n=JSON.parse(this.get("payload").replace("\\'","'"));a=n&&"object"==typeof n?n:{}}catch(e){a={}}else a={};this.set("payload",a)}get id(){return this.get("id")}get attachments(){return ie.null(this.details.attachments)?[]:JSON.parse(this.details.attachments)}get message(){return $?this.payload("translation")&&this.payload("translation-language")==SB_ADMIN_SETTINGS.active_agent_language?this.payload("translation"):this.payload("original-message-language")==SB_ADMIN_SETTINGS.active_agent_language?this.payload("original-message"):this.get("message"):this.get("message")}get(e){return e in this.details&&!ie.null(this.details[e])?this.details[e]:""}set(e,t){this.details[e]=t}payload(e=!1,t=!1){let i=this.get("payload");if(!1!==e&&!1!==t)i[e]=t,this.set("payload",i);else if(!1!==e)return e in i?i[e]:!(!i.id||i.id!=e)&&i;return["boolean","string"].includes(typeof i)?[]:i}getCode(){let e=ie.isAgent(this.details.user_type),t=this.message,i=this.attachments,s=$?SBAdmin.conversations.messageMenu(e,t):"",a="",n="",o=$&&SB_ADMIN_SETTINGS.show_profile_images||!$&&(e&&!P.hide_agents_thumb||!e&&P.display_users_thumb)?`<div class="sb-thumb"><img loading="lazy" src="${this.details.profile_image}"><div class="sb-tooltip"><div>${this.details.full_name}</div></div></div>`:"",r=($&&e||!$&&!e?"sb-right":"")+(o?" sb-thumb-active":""),l="",c=!$&&e&&P.sender_name||$&&"chat-admin"==SB_ADMIN_SETTINGS.sender_name?`<span class="sb-agent-name">${this.get("full_name")}</span>`:"",d=!!$&&this.payload().delivery_failed;if(!t&&!i.length)return"";if(e){let e=(t=(t=t.replace(/\n/g,"<br>")).replace(/`([\s\S]*?)`/g,e=>e.replace(/\[/g,"&#91;"))).match(/\[([^\[\]]*(?:\[[^\[\]]*\][^\[\]]*)*)\]/g)||[],i=!1,s=e.length;for(h=0;h<s;h++){let s=le.shortcode(e[h]);if(s[0])if("action"==s[0])t=t.replace(e[h],"");else{let a=le.generate(s[1],s[0]);a&&(t=t.replace(e[h],a),i=!0,l=`data-type="${s[0]}"`)}}i&&(r+=" sb-rich-cnt",s>1&&(l='data-type="multiple"'))}else if(t.includes("[rating ")){let e=le.shortcode(t);t=le.generate(e[1],e[0])}let u=t.includes("data-success")?[...t.matchAll(/data-success="([^"]*)"/g)].map(e=>e[1]):[];for(h=0;h<u.length;h++)t=t.replace(u[h],"{R"+h+"}");t=this.render(t);for(h=0;h<u.length;h++)t=t.replace("{R"+h+"}",u[h]);if(i.length){a='<div class="sb-message-attachments">';for(var h=0;h<i.length;h++){let e=i[h][1],s=e+i[h][0];if("image"==ie.getFileType(s)){let t="";i[h].length>2&&(t=`width="${(t=i[h][2].split("|"))[0]}" style="aspect-ratio: ${t[0]} / ${t[1]}"`),n+=`<div class="sb-image${s.includes(".png")?" sb-image-png":e.includes("sticker_")?" sb-image-sticker":""}"><img loading="lazy" src="${e}" ${t}/></div>`}else"audio"==ie.getFileType(s)||e.includes("voice_message")||e.includes("audioclip")?(($&&!SB_ADMIN_SETTINGS.speech_recognition||!$&&!P.speech_recognition)&&(t=""),a+=`<div class="sb-player"><div class="sb-player-btn sb-icon-play"></div><div class="sb-player-speed"><div class="sb-player-speed-number">1</div><div class="sb-icon-close"></div></div><div class="sb-player-download sb-icon-arrow-down"></div><audio><source src="${e}" type="audio/mpeg"></audio></div>`):a+=`<a rel="noopener" target="_blank" href="${e}">${ie.beautifyAttachmentName(i[h][0])}</a>`}a+="</div>"}return`<div data-id="${this.details.id}" class="${r}" ${l}>${o}<div class="sb-cnt"><div class="sb-message${n&&!t?" sb-message-media":""}"${d?' style="opacity:.7"':""}>${d?SBAdmin.conversations.getDeliveryFailedMessage(d):""}${(c+t+n).trim()}</div>${a}<div class="sb-time">${ie.beautifyTime(this.details.creation_time,!0)}${$&&e&&2==this.details.status_code?'<i class="sb-icon-check"></i>':""}</div></div>${s}</div>`}render(t=!1){!1===t&&(t=""+this.details.message);let i=t.length,s=t.match(/```([\s\S]*?)```/g)||[];for(n=0;n<s.length;n++)t=t.replace(s[n],"[code-"+n+"]");if(t=t.replace(/(?:\r\n|\r|\n)/g,"<br>"),t=t.replace(/\*([^\**]+)\*/g,"<b>$1</b>"),t=t.replace(/__(.+?)__/g,"<i>$1</i>"),t=t.replace(/\~([^\~~]+)\~/g,"<del>$1</del>"),t=t.replace(/\`([^\``]+)\`/g,"<code>$1</code>"),((6==i||5==i)&&t.startsWith("&#x")||i<3&&t.match(/(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|\ud83c[\ude32-\ude3a]|\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])/))&&(t=`<span class="emoji-large">${t}</span>`),t.includes("](http")){let e=t.split("[");t="";for(n=0;n<e.length;n++)e[n].includes("](http")&&(e[n]=e[n].substring(e[n].indexOf("](")+2,e[n].length-1)),t+=e[n]}t.includes("www.")&&(t=t.replaceAll("www.","https://www.").replaceAll("https://https:","https:").replaceAll("http://https:","http:"));let a=[['href="http',"[L1]"],['src="http',"[L2]"],['url("http',"[L3]"],["url('http","[L4]"],['extra="http',"[L5]"],['data-link="http',"[L6]"]];for(n=0;n<a.length;n++)t=t.replaceAll(a[n][0],a[n][1]);t.includes("http")&&(t=t.autoLink({target:"_blank",callback:function(e){return e.includes("#sb-")?`<a href="${e.split("#sb-")[0]}" target="_blank">${e.split("#sb-")[1].replaceAll("--"," ")}</a>`:null}}));for(n=0;n<a.length;n++)t=t.replaceAll(a[n][1],a[n][0]);for(var n=0;n<s.length;n++)t=t.replace("[code-"+n+"]","<pre>"+e.trim(e.trim(s[n].replace(/```<br>/g,"```").replace(/<br>```/g,"```")).replace(/```/g,"").replace(/(?:\r\n|\r|\n)/g,"<br>"))+"</pre>");return t.replace(/&amp;lt;/g,"&lt;")}strip(e=!1){return ie.strip(!1===e?""+this.details.message:e)}}window.SBMessage=ne;class oe{constructor(e,t){this.details=ie.null(t)?{}:t,Array.isArray(e)?(this.messages=[],e.length&&(e[0]instanceof ne?this.messages=e:ie.error("Messages not of type SBMessage","SBConversation.constructor"))):ie.error("Message array not of type Array","SBConversation.constructor");let i=["conversation_id","conversation_user_id","conversation_first_name","conversation_last_name","conversation_profile_image","conversation_user_type","conversation_creation_time","conversation_status_code"],s=["payload"];for(a=0;a<i.length;a++)t[i[a]]&&(this.details[i[a].replace("conversation_","")]=t[i[a]]),delete this.details[i[a]];for(var a=0;a<s.length;a++)delete this.details[s[a]];t&&(this.details.tags="tags"in t?"string"==typeof t.tags?t.tags.split(","):t.tags:[])}get id(){return this.get("id")}get status_code(){return this.get("status_code")}get(e){if(e in this.details&&!ie.null(this.details[e]))return this.details[e];if("title"==e){if(this.details.title)return this.details.title;if(this.details.first_name)return this.details.first_name+" "+this.details.last_name;if(this.messages.length)return this.messages[0].get("full_name")}return""}set(e,t){this.details[e]=t}getMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages[t].set("index",t),this.messages[t];return!1}getLastMessage(){for(var e=this.messages.length-1;e>-1;e--)if(this.messages[e].message||this.messages[e].attachments.length||this.messages[e].payload("preview"))return this.messages[e];return!1}getLastUserMessage(e=!1,t=!1){!1===e&&(e=this.messages.length-1);for(var i=e;i>-1;i--){let e=this.messages[i],s=e.get("user_type");if((e.message||e.attachments.length)&&(!t&&!ie.isAgent(s)||!0===t&&("agent"==s||"admin"==s)||"bot"==t&&"bot"==s||"no-bot"==t&&"bot"!=s||"all"==t&&ie.isAgent(s)))return this.messages[i].set("index",i-1),this.messages[i]}return!1}getNextMessage(e,t=!1){let i=this.messages.length;for(var s=0;s<i;s++)if(this.messages[s].id==e&&s<i-1){for(var a=s+1;a<i;a++){let e=this.messages[a].get("user_type"),i=this.messages[s+1];if(!t||"agent"==t&&ie.isAgent(e)||"user"==t&&!ie.isAgent(e))return i}break}return!1}getUserMessages(e="user"){let t=[],i="user"==e?["visitor","lead","user"]:"agents"==e?["agent","admin"]:["bot"];for(var s=0;s<this.messages.length;s++)i.includes(this.messages[s].get("user_type"))&&(this.messages[s].set("index",s),t.push(this.messages[s]));return t}updateMessage(e,t){if(t instanceof ne){for(var i=0;i<this.messages.length;i++)if(this.messages[i].id==e)return this.messages[i]=t,!0}else ie.error("Message not of type SBMessage","SBConversation.updateMessage");return!1}addMessages(e){if(Array.isArray(e))for(var t=0;t<e.length;t++)e[t]instanceof ne&&this.messages.push(e[t]);else e instanceof ne?this.messages.push(e):ie.error("Messages not of type SBMessage","SBConversation.addMessages()");return this}getCode(e=!1){let t=this.getLastMessage();if(t){let n=t.message;if(!n&&t.payload("preview")&&(n=t.payload("preview")),$&&(n=t.payload().preview?t.payload().preview:n),!1!==(n=n.replace(/(\r\n|\n|\r)/gm," ")).indexOf("[")){let e=n.match(/\[.+?\]/g)||[];if(e.length){let t=le.shortcode(e[0]);t[0]&&(n=n.replace(e[0],"action"==t[0]?"":s(t[1].message?t[1].message:t[1].title?t[1].title:t[1].name?t[1].name:t[1].link?t[1].link:t[1].values?t[1].values.replaceAll(",",", ").replaceAll("  "," "):t[1].options?t[1].options.replaceAll(",",", ").replaceAll("  "," "):s(ie.slugToString(t[0])))))}}if(!n&&t.attachments.length)for(var i=0;i<t.attachments.length;i++)n+=t.attachments[i][0]+" ";if((n=ie.strip(n)).length>114&&(n=n.substr(0,114)+" ..."),e)return n;let o=this.get("title");return(!o||a()&&a().name==o||E&&P.tickets_conversations_title_user)&&(o=a()&&t.get("user_id")==a().id?s("You"):t.get("full_name")),`<div class="sb-conversation-item" data-user-id="${this.get("user_id")}"><img loading="lazy" src="${t.get("profile_image")}"><div><span class="sb-name">${o}</span><span class="sb-time">${ie.beautifyTime(t.get("creation_time"))}</span></div><div class="sb-message">${n}</div></div>`}return""}deleteMessage(e){for(var t=0;t<this.messages.length;t++)if(this.messages[t].id==e)return this.messages.splice(t,1),!0;return!1}searchMessages(e,t=!1){let i=[];for(var s=0;s<this.messages.length;s++){let a=this.messages[s].message;(t&&a==e||!t&&a.includes(e))&&(this.messages[s].set("index",s),i.push(this.messages[s]))}return i}getAttachments(){let e=[];for(var t=0;t<this.messages.length;t++){let s=this.messages[t].attachments;for(var i=0;i<s.length;i++){let a=s[i][1];e.push([s[i][0],a,a.substr(a.lastIndexOf(".")+1),this.messages[t].id])}}return e}updateMessagesStatus(e=!1){if(e)for(t=0;t<this.messages.length;t++){let i=this.messages[t].id;if(e.includes(i)){let e=h.find(`[data-id="${i}"] .sb-time`);e.find("i").length||e.append('<i class="sb-icon-check"></i>')}}else if(!$&&"visible"==ie.visibility_status){e=[];for(var t=0;t<this.messages.length;t++){let i=this.messages[t];ie.isAgent(i.get("user_type"))&&2!=i.get("status_code")&&(e.push(i.id),i.set("status_code",2))}e.length&&ie.ajax({function:"update-messages-status",message_ids:e})}}}window.SBConversation=oe;var re={emoji_options:{range:0,range_limit:47,list:[],list_now:[],touch:!1},initialized:!1,editor_listening:!1,conversation:!1,is_busy:!1,is_busy_update:!1,is_busy_populate:!1,chat_open:!1,real_time:!1,agent_id:-1,agent_online:!1,user_online:!1,expanded:!1,main_header:!0,start_header:!1,desktop_notifications:!1,flash_notifications:!1,id_last_message:0,id_last_message_conversation:0,datetime_last_message_conversation:"2000-01-01 00:00:00",audio:!1,audio_interval:!1,tab_active:!0,notifications:i("notifications")?i("notifications"):[],typing_settings:{typing:!1,sent:!1,timeout:!1},email_sent:!1,dashboard:!1,articles:!1,articles_allowed_ids:!1,articles_category:!1,slack_channel:[-1,-1],skip:!1,queue_interval:!1,departments:!1,default_department:null,default_agent:null,default_tags:null,offline_message_set:!1,sendMessage:function(t=-1,i="",n=[],o=!1,r=!1,l=!1){let c=S&&de.dialogflow.active(),d=!1,u=this.conversation;if(!a()&&!$)return this.addUserAndLogin(()=>this.sendMessage(t,i,n,o,r),!0),void this.busy(!0);if(!u){let e=!$&&a().getLastConversation();if(!e||"new-conversation"==G||re.default_department&&re.default_department!=e.get("department")||re.default_agent&&re.default_agent!=e.get("agent_id"))return this.newConversation(l,t,"",[],$&&SB_ACTIVE_AGENT.department?SB_ACTIVE_AGENT.department:null,null,()=>this.sendMessage(t,i,n,o,r)),void this.busy(!0);this.openConversation(e.id),this.setConversation(e),G=!1}this.calculateLabelDateFirst(),-1==t&&(t=$?SB_ACTIVE_AGENT.id:a().id);let f=t!=w;if(i||n.length||(i=p.val().trim(),g.find(".sb-attachments > div").each(function(){let t=[e(this).attr("data-name"),e(this).attr("data-value")];e(this).attr("data-size")&&t.push(e(this).attr("data-size")),n.push(t)}),$&&SBAdmin.must_translate&&i&&(de.dialogflow.translate([i],a().language,e=>{if(e.length){let t=$?SB_ADMIN_SETTINGS.active_agent_language:a().language;r?(r["original-message"]=i,r["original-message-language"]=t):r={"original-message":i,"original-message-language":t},e[0]&&(i=e[0])}this.sendMessage(t,i,n,o,r,l)}),d=!0)),this.busy(!0),f&&(p.val("").css("height",""),g.find(".sb-attachments").html("")),g.sbActive(!1),!d)if(!1===l&&t==w&&(l="skip"),$||!f||c||(l=2),i||n.length||r){let e={user_id:t,user:a(),conversation_id:u.id,conversation:u,conversation_status_code:l,attachments:n};ie.ajax({function:"send-message",user_id:t,conversation_id:u.id,message:i,attachments:n,conversation_status_code:l,queue:!$&&P.queue&&f,payload:r,recipient_id:!!$&&a().id},s=>{let l=$||!c||s.human_takeover_active;$||t!=w||(this.dashboard?this.updateConversations():this.chat_open||this.updateNotifications(u.id,s.id)),($&&!this.user_online||!$&&!this.agent_online)&&this.update(),$||!f||S||(this.followUp(),this.offlineMessage()),!$&&f&&(!r||"sb-human-takeover"!=r.id&&ie.null(r["skip-dialogflow"]))&&de.dialogflow.message(i,n),!$&&f&&"visitor"==a().type?ie.ajax({function:"update-user-to-lead",user_id:t},()=>{a().set("user_type","lead"),P.slack_active&&l&&this.slackMessage(t,a().name,a().image,i,n)}):l&&!this.skip&&($&&SB_ADMIN_SETTINGS.slack_active?this.slackMessage(a().id,SB_ACTIVE_AGENT.full_name,SB_ACTIVE_AGENT.profile_image,i,n):P.slack_active&&this.slackMessage(a().id,f?a().name:P.bot_name,f?a().image:P.bot_image,i,n)),f&&P.language_detection&&u&&i.split(" ").length>1&&!ie.storage("language-detection-completed")&&(ie.ajax({function:"google-language-detection-update-user",user_id:t,string:i,token:de.dialogflow.token},e=>{e&&(P.translations=e)}),ie.storage("language-detection-completed",!0)),!this.articles||$||!P.articles||P.office_hours||this.isInitDashboard()||setTimeout(()=>{this.conversation&&u.id==this.conversation.id&&(this.sendMessage(w,"[articles]"),this.scrollBottom(),this.articles=!1)},5e3),s.queue&&this.queue(this.conversation.id),e.message=s.message,e.message_id=s.id,ie.event("SBMessageSent",e),E&&SBTickets.onMessageSent(),o&&o(e),s.notifications.length&&ie.event("SBNotificationsSent",s.notifications),this.skip&&(this.skip=!1),this.busy(!1)}),f&&(i=ie.escape(i),h.append(new ne({id:"sending",profile_image:$?SB_ACTIVE_AGENT.profile_image:a().image,full_name:$?SB_ACTIVE_AGENT.full_name:a().name,creation_time:"0000-00-00 00:00:00",message:i.replaceAll("<","&lt;"),user_type:$?"agent":"user"}).getCode().replace('<div class="sb-time"></div>',`<div class="sb-time">${s("Sending")}<i></i></div>`))),this.dashboard||!f&&!this.isBottom()||this.scrollBottom()}else this.busy(!1)},updateMessage:function(e,t=""){ie.ajax({function:"update-message",message_id:e,message:t})},sendEmail:function(e,t,i=!1,s=!1){let n=i?!0===i?a().id:i:this.getRecipientUserID();if(!$&&!isNaN(n)&&this.agent_online)return!1;ie.ajax({function:"create-email",recipient_id:n,sender_name:$?i?SB_ACTIVE_AGENT.full_name:a().name:i?P.bot_name:a().name,sender_profile_image:$?i?SB_ACTIVE_AGENT.profile_image:a().name:i?P.bot_image:a().image,message:e,attachments:t,department:!!this.conversation&&this.conversation.get("department"),conversation_id:!!this.conversation&&this.conversation.id},e=>{s&&s(e)})},sendSMS:function(e){let t=this.getRecipientUserID();if(!$&&!isNaN(t)&&this.agent_online)return!1;ie.ajax({function:"send-sms",to:t,message:e,conversation_id:!!this.conversation&&this.conversation.id},t=>{"sent"==t.status||"queued"==t.status?ie.event("SBSMSSent",{recipient_id:this.getRecipientUserID(),message:e,response:t}):t.message&&ie.error(t.message,"SBChat.sendSMS")})},desktopNotification:function(e,t,i,s=!1,n=!1){if("granted"!==Notification.permission)Notification.requestPermission();else{ie.serviceWorker.sw.showNotification(e,{body:ie.strip(t),icon:i.indexOf("user.svg")>0?P.notifications_icon:i}).onclick=(()=>{$?s?(SBAdmin.conversations.openConversation(s,0==n?a().id:n),SBAdmin.conversations.update()):n&&SBAdmin.profile.show(n):this.start(),window.focus()})}},getRecipientUserID:function(){return $?a().id:this.lastAgent(!1)?this.lastAgent(!1).user_id:ie.null(this.conversation.get("agent_id"))?ie.null(this.conversation.get("department"))?"agents":"department-"+this.conversation.get("department"):this.conversation.get("agent_id")},submit:function(){if(!this.is_busy){if(C&&C.sbActive()){let e=C.find(".sb-btn-mic");return C.sbActive(!1),e.hasClass("sb-icon-pause")&&e.click(),void setTimeout(()=>{let e=new FormData,t=!!this.conversation&&this.conversation.get("source");"wa"==t||X.length?(e.append("file",new File(["wa"==t?SBAudioRecorder.blob():new Blob(X,{type:"ig"==t?"audio/wav":"audio/mp3"})],"voice_message."+("ig"==t?"wav":"mp3"))),ie.upload(e,e=>{re.uploadResponse(e),this.submit()})):this.submit(),C.find(".sb-icon-close").click()},100)}this.sendMessage(),P.cron_email_piping_active&&(setTimeout(()=>{ie.ajax({function:"email-piping"}),P.cron_email_piping_active=!0},6e4),P.cron_email_piping_active=!1),Z&&ie.serviceWorker.initPushNotifications()}},initChat:function(){$||ie.getActiveUser(!0,()=>{let e=!1!==a(),t=!!e&&a().type;if(E||!P.popup||i("popup")||q&&P.popup_mobile_hidden||this.popup(),re.automations.runAll(),E||!P.privacy||P.registration_required||i("privacy-approved")){if(typeof Notification!==W&&!P.push_notifications_users&&(["all","users"].includes(P.desktop_notifications)||$&&"agents"==P.desktop_notifications)&&(this.desktop_notifications=!0),(["all","users"].includes(P.flash_notifications)||$&&"agents"==P.flash_notifications)&&(this.flash_notifications=!0),this.registration(!0)&&!E)return this.registration(),void(!e&&P.visitors_registration&&this.addUserAndLogin());e||!(typeof SB_WP_WAITING_LIST!==W||P.visitors_registration||P.welcome||E||P.flow_on_load)||E&&P.tickets_registration_required?!this.conversation&&e?this.populateConversations():this.finalizeInit():this.addUserAndLogin(()=>{this.welcome(),de.woocommerce.waitingList(),this.finalizeInit()}),P.header_name&&e&&"user"==t&&!E&&f.find(".sb-title").html(`${s("Hello")} ${a().nameBeautified}!`),this.welcome(),se.active||setInterval(()=>{this.updateConversations(),this.updateUsersActivity()},10200),de.dialogflow.flowOnLoad(),de.woocommerce.waitingList(),this.scrollBottom(!0)}else this.privacy()})},finalizeInit:function(){this.initialized||(l.attr("style",""),$||E||(this.isInitDashboard()&&this.showDashboard(),!q&&window.innerHeight<760&&l.find(" > .sb-body").css("max-height",window.innerHeight-130+"px")),this.initialized=!0,$||(a()&&!this.registration(!0)&&(i("open-conversation")&&this.openConversation(i("open-conversation")),ie.getURL("conversation")&&this.openConversation(ie.getURL("conversation"))),(!this.chat_open&&(!q&&i("chat-open")||"open"==ie.getURL("chat"))||ie.getURL("conversation"))&&setTimeout(()=>{this.start()},500),P.woocommerce_returning_visitor&&(!1===i("returning-visitor")?ie.storageTime("returning-visitor"):ie.storageTime("returning-visitor",24)&&!i("returning-visitor-processed")&&setTimeout(()=>{ie.ajax({function:"woocommerce-returning-visitor"},()=>{i("returning-visitor-processed",!0)})},15e3)),P.timetable_type&&re.offlineMessage(),P.queue_human_takeover&&de.dialogflow.humanTakeoverActive()&&(P.queue=!0),e(window).on("resize",function(){!q&&window.innerHeight<760&&l.find(" > .sb-body").css("max-height",window.innerHeight-130+"px")}),de.dialogflow.flowOnLoad()),E&&SBTickets.init(),ie.event("SBInit"))},start:function(){this.initialized&&(this.populate(),this.headerAgent(),this.updateUsersActivity(),this.startRealTime(),this.popup(!0),this.conversation&&this.updateNotifications(this.conversation.id),l.sbActive(!0),e("body").addClass("sb-chat-open"),this.chat_open=!0,"open"!=P.welcome_trigger||this.registration(!0)||this.welcome(),de.martfury.privateChat(),this.calculateLabelDates())},open:function(t=!0){t&&!this.chat_open?(this.start(),this.chat_open=!0,this.startRealTime(),l.sbActive(!0),e("body").addClass("sb-chat-open"),i("chat-open",!0),this.conversation&&i("last-open-message",this.conversation.getLastMessage().id),q&&history.pushState({"chat-open":!0},"",""),ie.event("SBChatOpen")):!t&&this.chat_open&&(l.sbActive(!1),this.stopRealTime(),this.chat_open=!1,i("chat-open",!1),e("body").removeClass("sb-chat-open"),ie.event("SBChatClose"))},openConversation:function(e){a().getFullConversation(e,t=>{if(!t.id||!re.isConversationAllowed(t.get("source"),t.status_code))return i("open-conversation",""),!1;this.setConversation(t),this.hideDashboard(),this.populate(),this.main_header=!1,i("chat-open")&&re.open(),i("queue")==e&&this.queue(e),(this.chat_open||E)&&this.updateNotifications(e),E&&SBTickets.activateConversation(t),i("open-conversation",e),ie.event("SBConversationOpen",t)})},update:function(){if(this.conversation){if(this.is_busy_update)return;let e=this.conversation.getLastMessage(),t=!1;ie.ajax({function:"get-new-messages",conversation_id:this.conversation.id,datetime:this.datetime_last_message_conversation,last_id:this.id_last_message_conversation},s=>{let n=s.length;if(this.is_busy_update=!1,this.conversation&&Array.isArray(s)&&n>0&&(!e||e.id!=s[n-1].id||e.message!=s[n-1].message||e.payload!=s[n-1].payload||e.attachments!=s[n-1].attachments)){let e="",r=[],l=[],c=!1;this.calculateLabelDateFirst();for(var o=0;o<n;o++)if(!l.includes(s[o].id)){let n=new ne(s[o]),d=n.payload();if(this.id_last_message_conversation=n.id,this.datetime_last_message_conversation=n.get("creation_time"),d.event){let e=d.event;("delete-message"!=e||!1===this.conversation.getMessage(n.id))&&($||n.message||n.attachments.length||d)||this.deleteMessage(n.id),"woocommerce-update-cart"!=e||$||de.woocommerce.updateCart(d.action,d.id),"woocommerce-checkout"!=e||$||de.wordpress.ajax("url",{url_name:"checkout"},e=>{setTimeout(()=>document.location=e,500)}),de.dialogflow.active()||"conversation-status-update-3"!=e&&"conversation-status-update-4"!=e&&"activate-bot"!=e||(de.dialogflow.active("activate"),c=!0),"conversation-status-update-3"==e&&this.conversationArchived()}d["human-takeover"]&&P.queue_human_takeover&&(P.queue=!0,re.queue(re.conversation.id)),d["human-takeover-fallback"]&&(de.dialogflow.typing_enabled=!1),this.conversation.getMessage(s[o].id)?(this.conversation.updateMessage(n.id,n),h.find(`[data-id="${n.id}"]`).replaceWith(n.getCode()),t=!0):((n.message||n.attachments.length)&&h.find('[data-id="sending"]').remove(),this.conversation.id==s[o].conversation_id&&(this.conversation.addMessages(n),e+=n.getCode(),t=!1)),this.conversation.updateMessagesStatus(),r.push(n),l.push(n.id),this.chat_open&&i("last-open-message",n.id),$||!this.dashboard&&this.chat_open&&this.tab_active||n.get("user_id")==a().id||!n.message&&!n.attachments.length||this.updateNotifications(this.conversation.id,n.id)}h.append(e);let d=this.conversation.getLastMessage(),u=!!d&&d.get("user_type"),g=ie.isAgent(u),p=g&&"bot"!=u;!$&&p&&(this.chat_open&&(!d||d.message.includes("sb-rich-success")||s[0].payload&&s[0].payload.includes("conversation-status-update")||this.setConversationStatus(0),P.follow&&clearTimeout(I)),c||de.dialogflow.active(!1)),i("queue")==this.conversation.id&&p&&this.queue("clear"),ie.null(r[0].message)&&ie.null(r[0].attachments)&&1==n||($||this.tab_active||this.flashNotification(),this.audio&&(!$&&g||$&&!g)&&this.playSound()),this.headerAgent(),t||this.dashboard||(this.scrollBottom(),setTimeout(()=>{this.scrollBottom()},300)),!P.auto_open||!this.dashboard&&this.chat_open||this.open(),p&&this.typing(-1,"stop"),this.busy(!1),ie.event("SBNewMessagesReceived",{messages:r,conversation_id:this.conversation.id}),E&&SBTickets.onNewMessageReceived(r[0],this.conversation.id)}}),this.is_busy_update=!0,setTimeout(()=>{this.is_busy_update=!1},5e3)}else this.updateConversations()},updateConversations:function(){a()&&ie.ajax({function:"get-new-user-conversations",datetime:this.id_last_message},e=>{if(e.length){this.id_last_message=e[0].message_id,this.chat_open&&i("last-open-message",this.id_last_message);for(var t=0;t<e.length;t++){let i=e[t].conversation_status_code;if(!re.isConversationAllowed(e[t].source,i))continue;let s=e[t].conversation_id,n=new ne(e[t]),o=new oe([n],e[t]),r=a().addConversation(o);e[t].message_user_id==a().id||this.conversation.id==s&&this.chat_open||!n.message&&!n.attachments.length||(this.updateNotifications(s,n.id),P.auto_open&&this.open());let l=n.payload();if("boolean"!=typeof l&&l.event){if("open-chat"==l.event&&((this.conversation.id!=s||this.dashboard)&&this.openConversation(s),q||setTimeout(()=>{this.open()},500)),!n.message&&!n.attachments.length)continue}this.tab_active||(this.desktop_notifications&&re.desktopNotification(n.get("full_name"),n.message,n.get("profile_image")),this.flash_notifications&&this.flashNotification(),$||!this.audio||!P.sound||this.chat_open&&!this.dashboard&&this.conversation.id==s||ie.null(n.message)&&ie.null(n.attachments)||this.playSound()),r&&ie.event("SBNewConversationReceived",o),E&&SBTickets.onConversationReceived(o)}this.conversation&&this.conversation.updateMessagesStatus(),l.find(".sb-user-conversations").html(a().getConversationsCode()),l.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",l.find(".sb-user-conversations > li").length>3)}})},populate:function(){if(this.conversation){let t="",a=h.find(" > .sb-notify-message"),n=!1,o=this.conversation.id;for(var e=0;e<this.conversation.messages.length;e++){let i=this.conversation.messages[e],a=ie.beautifyTime(i.get("creation_time"));a.includes("today")&&(a=`<span>${s("Today")}</span>`),a!=n&&(i.message||i.attachments.length)&&(t+=`<div class="sb-label-date">${a}</div>`,n=a),t+=i.getCode()}if(h.html((a.length?a[0].outerHTML:"")+t),!this.dashboard&&(this.scrollBottom(),this.calculateLabelDates(),$&&SB_ADMIN_SETTINGS.notify_email_cron||!$&&P.notify_email_cron)){let e=this.conversation.getLastUserMessage(!1,!$);e&&e.id!=i("email-cron-"+o)&&(ie.ajax({function:"remove-email-cron",conversation_id:o}),i("email-cron-"+o,e.id))}}else a()&&!a().isConversationsEmpty()&&(P.disable_dashboard?this.openConversation(a().conversations[0].id):this.showDashboard())},populateConversations:function(e=!1){!this.is_busy_populate&&a()&&(this.is_busy_populate=!0,setTimeout(()=>{this.is_busy_populate=!1},5e3),a().getConversations(t=>{let s=t.length,n=[];if(s){let e=Date.now(),r=t[0].messages[0];this.id_last_message=r.id;for(o=0;o<s;o++)n.push(t[o].id),E||1!=t[o].status_code||!(i("last-open-message")<r.id)||this.conversation&&this.conversation.id==t[o].id||this.updateNotifications(t[o].id,r.id),!q&&e-ie.UTC(t[o].messages[0].get("creation_time"))<6e3&&this.open();l.find(".sb-user-conversations").html(a().getConversationsCode()),l.find(".sb-dashboard-conversations").setClass("sb-conversations-hidden",l.find(".sb-user-conversations > li").length>3)}l.setClass("sb-no-conversations",!s),this.initialized&&"open-conversation"!=G||1!=s||this.isInitDashboard()||i("open-conversation")||(this.openConversation(a().getLastConversation().id),"open-conversation"==G&&(G=""));for(var o=0;o<re.notifications.length;o++)this.updateNotifications(re.notifications[o][0],!!n.includes(re.notifications[o][0])&&re.notifications[o][1]);e&&e(t),this.finalizeInit(),ie.event("SBPopulateConversations",{conversations:t})}))},newConversation:function(e,t=-1,i="",s=[],n=null,o=null,r=!1){a()?ie.ajax({function:"new-conversation",status_code:e,title:E?l.find(".sb-ticket-title input").val():null,department:ie.null(n)?this.default_department:n,agent_id:ie.null(o)?this.default_agent:o,tags:this.default_tags,source:E?"tk":""},l=>{if(ie.errorValidation(l,"user-not-found"))return void this.addUserAndLogin(()=>{this.newConversation(e,t,i,s,n,o,r)});let c=new oe([],l.details);this.setConversation(c),(i||s.length)&&this.sendMessage(t,i,s),t!=w&&setTimeout(()=>{this.queue(c.id)},1e3),a().conversations.push(c),r&&r(c)}):ie.error("activeUser() not setted","SBChat.newConversation")},setConversation:function(e){if(e instanceof oe){let s=a().conversations;this.conversation=e,this.id_last_message_conversation=this.conversation.getLastMessage()?this.conversation.getLastMessage().id:0,this.datetime_last_message_conversation=0==this.conversation.getLastMessage()?"2000-01-01 00:00:00":this.conversation.getLastMessage().get("creation_time"),e.id!=this.conversation.id&&this.queue(e.id);for(var t=0;t<s.length;t++)if(s[t].id==e.id){s[t]=e;break}i("open-conversation",e.id),de.dialogflow.typing_enabled=!0,ie.event("SBActiveConversationChanged",e)}else ie.error("Value not of type SBConversation","SBChat.setConversation")},queue:function(e){if("clear"==e)return l.removeClass("sb-notify-active sb-queue-active"),h.find(" > .sb-notify-message").remove(),clearInterval(this.queue_interval),this.queue_interval=!1,i("queue",""),void(P.queue_sound&&!re.tab_active&&re.playSound(999));!$&&P.queue&&ie.ajax({function:"queue",conversation_id:e,department:this.conversation.get("department")},t=>{h.find(" > .sb-notify-message").remove();let a=t[0];if(0==a)this.queue("clear");else{let n=(P.queue_response_time?parseInt(P.queue_response_time):5)*a,o=s(P.queue_message?P.queue_message:"Please wait for an agent. You are number {position} in the queue. Your waiting time is approximately {minutes} minutes.").replace("{position}","<b>"+a+"</b>").replace("{minutes}","<b>"+n+"</b>");t[1]&&h.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${o}</div></div></div>`),!1===this.queue_interval&&(this.queue_interval=setInterval(()=>{this.queue(e)},10100),t[1]&&l.addClass("sb-notify-active sb-queue-active"),i("queue",e))}ie.event("SBQueueUpdate",a)})},getDepartmentCode(e,t){if(this.departments)if("all"==e){let e="";for(var i in this.departments)this.getDepartmentCode(this.departments[i].id,t=>{e+=t});t(e)}else t(`<div data-color="${this.departments[e].color}">${this.departments[e].image?`<img loading="lazy" src="${this.departments[e].image}" />`:""}<div>${this.departments[e].name}<div></div>`);else ie.ajax({function:"get-departments"},i=>{i&&(this.departments=i,this.getDepartmentCode(e,t))})},startRealTime:function(){se.active||(this.stopRealTime(),this.real_time=setInterval(()=>{this.update(),this.typing($?a()?a().id:-1:this.agent_id,"check")},1e3))},stopRealTime:function(){clearInterval(this.real_time)},updateUsersActivity:function(){a()&&ie.updateUsersActivity(a().id,this.agent_id,t=>{this.typing_settings.typing||("online"==t||this.agent_id==w?(e(m).addClass("sb-status-online").html(s("Online")),this.agent_online=this.agent_id!=w):(e(m).removeClass("sb-status-online").html(s("Away")),this.agent_online=!1))})},busy:function(e){g&&g.find(".sb-loader").sbActive(e),this.is_busy=e,ie.event("SBBusy",e)},headerAgent:function(e=!1){if(!$&&!E&&!this.dashboard&&this.conversation&&(-1==this.agent_id||this.conversation.getLastMessage()&&ie.isAgent(this.conversation.getLastMessage().get("user_type"))&&this.conversation.getLastMessage().get("user_id")!=this.agent_id)){let t=this.lastAgent(!1);!(t=t&&de.dialogflow.humanTakeoverActive()&&se.active&&!se.presenceCheck({info:{user_type:"agent"},id:t.user_id})?t:this.lastAgent())&&e&&(t={user_id:P.bot_id,full_name:P.bot_name,profile_image:P.bot_image}),t&&(this.agent_id=t.user_id,this.headerReset(),f.addClass("sb-header-agent").attr("data-agent-id",this.agent_id).html(`<div class="sb-dashboard-btn sb-icon-arrow-left"></div><div class="sb-profile"><img loading="lazy" src="${t.profile_image}" /><div><span class="sb-name">${t.full_name}</span><span class="sb-status">${s("Away")}</span></div><i class="sb-icon sb-icon-close ${P.close_chat?"sb-close-chat":"sb-responsive-close-btn"}"></i></div><div class="sb-label-date-top"></div>`),m=f.find(".sb-status"),this.updateUsersActivity(),y=f.find(".sb-label-date-top"),ie.storageTime("header-animation",1)&&this.headerAnimation())}},headerReset:function(){0==this.start_header&&(this.start_header=[f.html(),f.attr("class")]),f.removeClass("sb-header-main sb-header-brand sb-header-agent sb-header-minimal"),this.main_header=!1},headerAnimation:function(){f.addClass("sb-header-animation"),setTimeout(()=>{f.removeClass("sb-header-animation")},8e3),ie.storageTime("header-animation")},lastAgent:function(e=!0){let t=!1;if(this.conversation){let i=this.conversation.getLastUserMessage(!1,!e||"all");i&&(t={user_id:i.get("user_id"),full_name:i.get("full_name"),profile_image:i.get("profile_image")})}return t},scrollBottom:function(e=!1){D=!1,setTimeout(()=>{D=!0},1e3),setTimeout(()=>{_.scrollTop(e?0:_[0].scrollHeight),this.scrollHeader()},20)},isBottom:function(){return _[0].scrollTop===_[0].scrollHeight-_[0].offsetHeight},scrollHeader:function(){if(this.main_header&&this.dashboard){let e=_.scrollTop();e>-1&&e<1e3&&f.find(".sb-content").css({opacity:1-e/500,top:e/10*-1+"px"})}},showDashboard:function(){$||E||(l.addClass("sb-dashboard-active"),f.removeClass("sb-header-agent"),this.hidePanel(),this.start_header&&f.html(this.start_header[0]).addClass(this.start_header[1]),_.find(" > div").sbActive(!1),l.find(".sb-dashboard").sbActive(!0),this.populateConversations(),this.conversation=!1,this.agent_id=-1,this.stopRealTime(),this.dashboard=!0,this.main_header=!0,this.scrollBottom(!0),ie.event("SBDashboard"))},hideDashboard:function(){$||E||(h.sbActive(!0),l.removeClass("sb-dashboard-active").find(".sb-dashboard").sbActive(!1),this.dashboard=!1,this.headerAgent(),this.scrollHeader(0),this.chat_open&&this.startRealTime(),ie.event("SBDashboardClosed"))},showPanel:function(e,t){if(E)return SBTickets.showPanel(e,t);let i=_.find(" > .sb-panel-"+e);i.length&&(_.find(" > div").sbActive(!1),i.sbActive(!0),this.start_header||(this.start_header=[f.html(),f.attr("class")]),f.attr("class","sb-header sb-header-panel").html(`<span>${s(t)}</span><div class="sb-dashboard-btn sb-icon-close"></div>`),l.addClass("sb-panel-active"),this.dashboard=!0),ie.event("SBPanelActive",e)},hidePanel:function(){l.removeClass("sb-panel-active"),f.removeClass("sb-header-panel")},clear:function(){this.conversation=!1,h.html("")},updateNotifications:function(e,t=!1){let s=!1;if(t){for(a=0;a<this.notifications.length;a++)this.notifications[a][0]==e&&t==this.notifications[a][1]&&(s=!0);s||(this.notifications.push([e,t]),!this.dashboard&&this.conversation&&this.conversation.id!=e&&this.headerAnimation())}else{let t=[];for(var a=0;a<this.notifications.length;a++)this.notifications[a][0]==e?s=!0:t.push(this.notifications[a]);!$&&s&&["0","2",0,2].includes(this.conversation.status_code)&&this.setConversationStatus(1),this.notifications=t}let n=this.notifications.length;i("notifications",this.notifications),l.find(".sb-chat-btn span").attr("data-count",n).html(n>-1?n:0),ie.event("SBNotificationsUpdate",{conversation_id:e,message_id:t})},setConversationStatus:function(e){return!!this.conversation&&(ie.ajax({function:"update-conversation-status",conversation_id:this.conversation.id,status_code:e},()=>{this.conversation.set("status_code",e),ie.event("SBActiveConversationStatusUpdated",{conversation_id:this.conversation.id,status_code:e})}),!0)},typing:function(t=-1,i="check"){if(this.conversation){let n=this.agent_online||$&&this.user_online;if("check"==i&&!se.active&&-1!=t&&t!=w&&n)ie.ajax({function:"is-typing",user_id:t,conversation_id:this.conversation.id},e=>{e&&!this.typing_settings.typing?this.typing(-1,"start"):!e&&this.typing_settings.typing&&this.typing(-1,"stop")});else if("set"==i&&n){let e=this.conversation.get("source");clearTimeout(L),e&&(e="fb"==e?[e,a().getExtra("facebook-id").value,this.conversation.get("extra")]:"tw"==e&&[e,a().getExtra("twitter-id").value]),se.active?ie.debounce(()=>{se.trigger("client-typing",{user_id:$?SB_ACTIVE_AGENT.id:a().id,conversation_id:this.conversation.id}),e&&ie.ajax({function:"set-typing",source:e})},"#2"):this.typing_settings.sent?(clearTimeout(this.typing_settings.timeout),this.typing_settings.timeout=setTimeout(()=>{ie.ajax({function:"set-typing",user_id:t,conversation_id:-1},()=>{this.typing_settings.sent=!1})},2e3)):(this.typing_settings.sent=!0,ie.ajax({function:"set-typing",user_id:t,conversation_id:this.conversation.id,source:e}),this.typing(t,"set"))}else if("start"==i||"stop"==i){let t="start"==i;if(!$&&m)if(t)e(m).addClass("sb-status-typing").html(s("Typing"));else{let t=this.agent_online||this.agent_id==w;clearTimeout(L),e(m).removeClass("sb-status-typing").html(s(t?"Online":"Away")),t&&e(m).addClass("sb-status-online")}this.typing_settings.typing=t,ie.event("SBTyping",t)}}},showArticles:function(e=!1,t=!1){let i=E?l.find(".sb-panel-main .sb-panel"):_.find(" > .sb-panel-articles");i.html("").sbLoading(!0),this.showPanel("articles",P.articles_title?P.articles_title:"Help Center"),!e&&P.articles_categories?this.getArticleCategories(e=>{this.showArticles_(e,i,{categories:e})},"parent"):this.getArticles(!t&&e,s=>{e&&!t?(i.html(this.getArticleCode(s[0])),i.sbLoading(!1),ie.event("SBArticles",{id:e,articles:s})):this.showArticles_(s,i,{id:e,articles:s})},!!t&&e)},showArticles_:function(e,t,i){let s="",a=typeof SB_LANG!=W&&SB_LANG[0];for(var n=0;n<e.length;n++){let t="content"in e[n];s+=`<div data-id="${e[n].id}"${t?"":' data-is-category="true"'}><div>${t?e[n].title:a&&e[n].languages&&e[n].languages[a]?e[n].languages[a].title:e[n].title}</div><span>${t?e[n].content:a&&e[n].languages&&e[n].languages[a]?e[n].languages[a].description:e[n].description?e[n].description:""}</span></div>`}t.html(`<div class="sb-articles">${s}</div>`),t.sbLoading(!1),ie.event("SBArticles",i)},getArticles:function(e=!1,t=!1,i=!1,s=!1){ie.ajax({function:"get-articles",categories:this.articles_category?this.articles_category:i,id:e||this.articles_allowed_ids,count:s,return_categories:!!this.articles_category,full:e,skip_language:!0},e=>{t(e)})},getArticleCategories:function(e=!1,t=!1){ie.ajax({function:"get-articles-categories",category_type:t},t=>{e(t)})},searchArticles:function(t,i,a){t&&(e(i).sbLoading(!0),ie.ajax({function:"search-articles",search:t},t=>{let n="";if(0==t.length)n+=`<p class="sb-no-results">${s("No articles found.")}</p>`;else for(var o=0;o<t.length;o++)n+=`<div data-id="${t[o].id}"><div>${t[o].title}</div><span>${t[o].content}</span></div>`;e(a).html(n),e(i).sbLoading(!1)}))},setArticleRating:function(e,t,i=!1){ie.ajax({function:"article-ratings",article_id:e,rating:t},e=>{i&&i(e)})},articleRatingOnClick:function(t){let i=e(t).closest(".sb-article");if(!i[0].hasAttribute("data-user-rating")){e(t).parent().sbLoading();let s="positive"==e(t).attr("data-rating")?1:-1,a=e(t).closest(".sb-article").attr("data-id");re.setArticleRating(a,s,()=>{ie.storage("article-rating-"+a,s),i.attr("data-user-rating",s),e(t).parent().sbLoading(!1)})}},getArticleCode:function(e){let t=ie.storage("article-rating-"+e.id),i="";if(this.articles_categories&&!ie.null(e.categories))for(var a=0;a<this.articles_categories.length;a++){let t=this.articles_categories[a].id;(e.categories.includes(t)||e.parent_category==t)&&(i+=`<span data-id="${t}">${s(this.articles_categories[a].title)}</span>`)}return`<div data-id="${e.id}"${t?` data-user-rating="${t}"`:""} class="sb-article"><div class="sb-title">${e.title}<div class="sb-close sb-icon-close"></div></div><div class="sb-content">${e.content.replace(/(?:\r\n|\r|\n)/g,"<br>")}</div>${e.link?`<a href="${e.link}" target="_blank" class="sb-btn-text"><i class="sb-icon-plane"></i>${s("Read more")}</a>`:""}${i?`<div class="sb-article-category-links">${i}</div>`:""}<div class="sb-rating"><span>${s("Rate and review")}</span><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>${s("Helpful")}</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>${s("Not helpful")}</span></i></div></div></div>`},initArticlesPage:function(){let i=ie.getURL("article_id"),a=ie.getURL("category"),n=ie.getURL("search");if(P.articles_url_rewrite){let e=location.href.replace(P.articles_url_rewrite,"").split("/");"category"==e[e.length-2]&&(a=e[e.length-1]),(2==e.length&&!e[0]&&e[1]||1==e.length&&e[0])&&(i=e[e.length-1]),P.articles_page_url}if((J=e("body").find("#sb-articles")).length||(J=e("body")),J.sbLoading()){let e=SB_URL+"/include/articles.php"+(a?"?category="+a:i?"?article_id="+i:n?"?search="+n:"");H&&(e+=(e.includes("?")?"&":"?")+"cloud="+H),ie.loadResource(SB_URL+"/css/articles.css"),ie.cors("GET",e,e=>{J.html(e),J.sbLoading(!1)})}J.on("keydown",".sb-panel-side input",function(t){13==t.which&&e(this).next().click()}),J.on("click",".sb-articles > [data-id]",function(){cache=panel_main.html(),panel_main.sbLoading(!0),re.getArticles(e(this).attr("data-id"),e=>{panel_main.removeClass("sb-articles").html(re.getArticleCode(e)),panel_main.sbLoading(!1)})}),J.on("click",".sb-article [data-rating]",function(){re.articleRatingOnClick(this)}),J.on("click",".sb-article .sb-title .sb-close",function(){J.find(".sb-panel-main").addClass("sb-articles").html(cache)}),J.on("click",".sb-submit-articles",function(){let t=e(this).parent().find("input").val();t?(cache=panel_main.html(),panel_main.html(""),re.searchArticles(t,this,panel_main)):panel_main.html(cache),panel_main.addClass("sb-articles")}),J.on("click",".sb-article-categories [data-id]",function(){if(t(panel_main))return;let i="";cache=panel_main.html(),J.find(".sb-article-categories [data-id]").sbActive(!1),e(this).sbActive(!0),re.getArticles(-1,e=>{for(var t=0;t<e.length;t++)i+=`<div data-id="${e[t].id}"><div>${e[t].title}</div><span>${e[t].content}</span></div>`;panel_main.addClass("sb-articles").html(i||`<p class="sb-no-results">${s("No articles found.")}</p>`),panel_main.sbLoading(!1)},e(this).attr("data-id"))})},categoryEmoji:function(e){let t=this.emoji_options.list;if("all"==e)this.emoji_options.list_now=t;else{this.emoji_options.list_now=[];for(var i=0;i<t.length;i++)t[i].category.startsWith(e)&&this.emoji_options.list_now.push(t[i])}this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()},mouseWheelEmoji:function(e){let t=this.emoji_options.range;(function(e){let t=e.originalEvent.wheelDelta;return typeof t==W&&(t=e.originalEvent.deltaY),typeof t==W&&(t=-1*e.originalEvent.detail),t})(e)>0||q&&typeof e.originalEvent.changedTouches!==W&&this.emoji_options.touch<e.originalEvent.changedTouches[0].clientY?t-=t<1?0:1:t+=t>this.emoji_options.range_limit?0:1,v.find(".sb-emoji-bar > div").sbActive(!1).eq(t).sbActive(!0),this.emoji_options.range=t,this.populateEmoji(t),e.preventDefault()},insertEmoji:function(t){t.indexOf(".svg")>0&&(t=e.parseHTML(t)[0].alt),this.insertText(t),v.sbTogglePopup()},showEmoji:function(e){v.sbTogglePopup(e)&&($||v.css({left:g.offset().left+(E?68:20),top:g.offset().top-window.scrollY-(E?g.height()-330:304)}),v.find(".sb-emoji-list > ul").html()||jQuery.ajax({method:"POST",url:SB_AJAX_URL,data:{function:"emoji","login-cookie":ie.loginCookie()}}).done(e=>{this.emoji_options.list=JSON.parse(e),this.emoji_options.list_now=this.emoji_options.list,this.populateEmoji(0),this.populateEmojiBar()}),ie.deselectAll())},populateEmoji:function(e){let t="",i=q?42:48,s=e*i+i,a=this.emoji_options.list_now;s>a.length&&(s=a.length),this.emoji_options.range_limit=a.length/i-1,this.emoji_options.range=e;for(var n=e*i;n<s;n++)t+=`<li>${a[n].char}</li>`;v.find(".sb-emoji-list").html(`<ul>${t}</ul>`)},populateEmojiBar:function(){let e='<div class="sb-active"></div>',t=q?42:49;for(var i=0;i<this.emoji_options.list_now.length/t-1;i++)e+="<div></div>";this.emoji_options.range=0,v.find(".sb-emoji-bar").html(e)},clickEmojiBar:function(t){let i=e(t).index();this.populateEmoji(i),this.emoji_options.range=i,v.find(".sb-emoji-bar > div").sbActive(!1).eq(i).sbActive(!0)},searchEmoji:function(e){ie.search(e,()=>{if(e.length>1){let i=this.emoji_options.list,s=[];for(var t=0;t<i.length;t++)(i[t].category.toLowerCase().includes(e)||i[t].name.toLowerCase().includes(e))&&s.push(i[t]);this.emoji_options.list_now=s}else this.emoji_options.list_now=this.emoji_options.list;this.emoji_options.range=0,this.populateEmoji(0),this.populateEmojiBar()})},textareaChange:function(t){let i=e(t).val();$&&(SBAdmin.conversations.savedReplies(t,i),SBAdmin.apps.openAI.rewriteButton(i)),i&&this.typing($&&!se.active?SB_ACTIVE_AGENT.id:a().id,"set"),g.sbActive(i)},insertText:function(t){let i=e(p.get(0)),s=0;if(this.dashboard)return!1;if(i.get(0).selectionStart)s=i.get(0).selectionStart;else if(document.selection){i.focus();let e=document.selection.createRange();var a=document.selection.createRange().text.length;e.moveStart("character",-i.value.length),s=e.text.length-a}i.val(i.val().substr(0,s)+t+i.val().substr(s)),i.focus(),i.manualExpandTextarea(),g.sbActive(!0)},enabledAutoExpand:function(){p.length&&p.autoExpandTextarea()},privacy:function(){ie.ajax({function:"get-block-setting",value:"privacy"},e=>{_.append(`<div class="sb-privacy sb-init-form" data-decline="${e.decline}"><div class="sb-title">${e.title}</div><div class="sb-text">${e.message.replace(/\n/g,"<br>")}</div>`+(e.link?`<a target="_blank" href="${e.link}">${e["link-name"]}</a>`:"")+`<div class="sb-buttons"><a class="sb-btn sb-approve">${e["btn-approve"]}</a><a class="sb-btn sb-decline">${e["btn-decline"]}</a></div></div>`),this.finalizeInit(),ie.event("SBPrivacy")}),this.dashboard||this.showDashboard(),this.dashboard=!0,l.addClass("sb-init-form-active")},popup:function(e=!1,t=!1){if(e){let e=l.find(".sb-popup-message"),t=e.attr("data-id");return i("popup"+(ie.null(t)?"":t),!0),void e.remove()}setTimeout(()=>{this.chat_open||(0==t&&(t=P.popup),l.find(".sb-popup-message").remove(),l.append(`<div data-id="${t.id?t.id:""}" class="sb-popup-message">`+(t.image?`<img loading="lazy" src="${t.image}" />`:"")+(t.title?`<div class="sb-top">${t.title}</div>`:"")+`<div class="sb-text">${t.message}</div><div class="sb-icon-close"></div></div>`),ie.event("SBPopup",t))},1e3)},followUp:function(){this.followUpCheck()&&(I=setTimeout(()=>{this.followUpCheck()&&ie.ajax({function:"execute-bot-message",conversation_id:this.conversation.id,name:"follow_up",check:!1},e=>{e.settings.sound&&this.audio&&this.audio.play(),this.skip=!0,ie.storageTime("email"),ie.event("SBFollowUp")})},!0===P.follow?P.office_hours||F?15e3:5e3:parseInt(P.follow)))},followUpCheck:function(){return!$&&this.conversation&&P.follow&&a()&&!a().email&&ie.storageTime("email",24)},welcome:function(){E||"open"==P.welcome_trigger&&!this.chat_open||!P.office_hours&&P.welcome_disable_office_hours||!P.welcome||i("welcome")||!a()||ie.ajax({function:"get-block-setting",value:"welcome"},e=>{setTimeout(()=>{P.dialogflow_welcome?!1===this.conversation?this.newConversation(3,-1,"",[],null,null,function(){de.dialogflow.welcome(e.open,e.sound)}):de.dialogflow.welcome(e.open,e.sound):(this.sendMessage(w,e.message,[],!1,!1,3),e.open&&!q&&this.start(),e.sound&&this.audio.play()),this.skip=!0,ie.event("SBWelcomeMessage")},parseInt(E?0:P.welcome_delay)),i("welcome",!0)})},offlineMessage:function(){if(!$&&P.timetable&&(!P.office_hours||!F&&!P.timetable_disable_agents)){let e=P.timetable_message;switch(P.timetable_type){case"header":this.offline_message_set||(e[0]&&f.find(".sb-title").html(e[0]),f.find(".sb-text").html(e[1]),this.offline_message_set=!0);break;case"info":this.offline_message_set||(h.prepend(`<div class="sb-notify-message sb-rich-cnt"><div class="sb-cnt"><div class="sb-message">${e[0]?`<b>${e[0]}</b> `:""}${e[1]}</div></div></div>`),l.addClass("sb-notify-active"),this.offline_message_set=!0);break;default:setTimeout(()=>{if(this.conversation){let t=P.timetable_hide?`${e[0]?`*${e[0]}*\n`:""}${e[1]}`:"[timetable]",i=this.conversation.searchMessages(t,!0);if(i=!!i.length&&i){let e=this.conversation.getLastUserMessage(!1,!0);i=!e||(e.get("index")<i[i.length-1].get("index")&&Date.now()-36e5)<ie.unix(i[0].get("creation_time"))}i||this.sendMessage(w,t)}},5e3)}}},slackMessage:function(e,t,i,s,n=[]){if(!this.conversation||!s&&!n.length)return!1;let o=this.conversation.id;ie.ajax({function:"send-slack-message",user_id:e,full_name:t,profile_image:i,conversation_id:o,message:s,attachments:n,channel:this.slack_channel[0]==a().id&&this.slack_channel[1]},e=>{this.slack_channel=[a().id,e[1]],ie.event("SBSlackMessageSent",{message:s,conversation_id:o,slack_channel:e[1]})})},deleteMessage:function(e){ie.ajax({function:"delete-message",message_id:e},()=>{this.conversation&&this.conversation.deleteMessage(e),h.find(`[data-id="${e}"]`).remove(),ie.event("SBMessageDeleted",e)})},registration:function(e=!1,t=P.registration_required){if(e)return P.registration_required&&(!P.registration_offline||!F)&&(typeof SB_DEFAULT_USER==W||!SB_DEFAULT_USER.email)&&(!P.registration_timetable||!P.office_hours)&&(!1===a()||["visitor","lead"].includes(a().type));_.append(le.generate({},P.registration_link||"registration-login"==P.registration_required?"login":t,"sb-init-form")),this.dashboard||this.showDashboard(),this.dashboard=!0,this.finalizeInit(),l.addClass("sb-init-form-active")},addUserAndLogin:function(e=!1,t=!1){let i=typeof SB_DEFAULT_USER!=W&&SB_DEFAULT_USER?SB_DEFAULT_USER:{};i.user_type=t?"lead":"visitor",ie.ajax({function:"add-user-and-login",settings:i,settings_extra:i.extra},i=>{if(ie.errorValidation(i)){if("duplicate-email"==i[1]||"duplicate-phone"==i[1])return delete SB_DEFAULT_USER.email,delete SB_DEFAULT_USER.extra.phone,this.addUserAndLogin(e,t)}else ie.loginCookie(i[1]),a(new ae(i[0])),se.start(),se.active||re.automations.runAll(),e&&e(i)})},isInitDashboard:function(){return P.init_dashboard||a()&&a().conversations.length>1},uploadResponse:function(t){if("success"==(t=JSON.parse(t))[0])if("extension_error"==t[1]){let e="The file you are trying to upload has an extension that is not allowed.";$?SBAdmin.infoPanel(e,"info"):alert(e)}else if(e(d).hasClass("sb-input-image")){let i=e(d).find(".image");i.attr("data-value")&&ie.ajax({function:"delete-file",path:i.attr("data-value")}),i.attr("data-value","").css("background-image",""),setTimeout(()=>{i.attr("data-value",t[1]).css("background-image",`url("${t[1]}?v=${ie.random()}")`).append('<i class="sb-icon-close"></i>'),d=!1},500)}else{let e=ie.beautifyAttachmentName(t[1].substr(t[1].lastIndexOf("/")+1));g.find(".sb-attachments").append(`<div data-name="${e}" data-value="${t[1]}"${t.length>2?' data-size="'+t[2][0]+"|"+t[2][1]+'"':""}>${e}<i class="sb-icon-close"></i></div>`),g.sbActive(!0)}else ie.error(t[1],"sb-upload-files.change");this.busy(!1)},closeChat:function(e=!0){let t=this.conversation.id;re.clear(),e?ie.ajax({function:"update-conversation-status",conversation_id:t,status_code:3},()=>{this.closeChat_(t)}):this.closeChat_(t)},closeChat_(e){l.find(`li[data-conversation-id="${e}"]`).remove(),G="new-conversation",re.clear(),i("open-conversation",""),i("welcome",""),i("flow_on_load",""),a().removeConversation(e),P.disable_dashboard||re.showDashboard()},conversationArchived:function(){let e=!E&&P.close_chat||E&&P.tickets_close;if(e&&!P.rating)return this.closeChat(!1);P.rating&&le.rating(e)},automations:{history:[],busy:[],scroll_position_intervals:{},timeout_queue:[],runAll:function(){let t=P.automations;for(var i=0;i<t.length;i++){let o=t[i],r=o.conditions,l=0==r.length,c=!1,d=!1,u=!1;for(var s=0;s<r.length;s++){let t=r[s][1];switch(l=!1,r[s][0]){case"browsing_time":l=!0,c=t;break;case"scroll_position":l=!0,d=t;break;case"referring":case"url":let i="referring"==r[s][0]?document.referrer:window.location.href,o=r[s][2].replace(/https?:\/\/|www\./g,"").split(",");i=i.replace(/https?:\/\/|www\./g,"");for(n=0;n<o.length;n++)if(i.includes(o[n])){l="contains"==t;break}break;case"include_urls":case"exclude_urls":let h="referring"==r[s][0]?document.referrer:window.location.href,g=r[s][2].replace(/https?:\/\/|www\./g,"").split(","),p="exclude_urls"!=r[s][0];p||(l=!0),h=h.replace(/https?:\/\/|www\./g,"");for(var n=0;n<g.length;n++)if(g[n]=e.trim(g[n].replace("https://","").replace("http://","").replace("www.","")),"contains"==t&&-1!=h.indexOf(g[n])||"does-not-contain"==t&&-1==h.indexOf(g[n])||"is-exactly"==t&&g[n]==h||"is-not"==t&&g[n]!=h){l=p;break}break;case"custom_variable":let f=t.split("=");f[0]in window&&window[f[0]]==f[1]&&(l=!0);break;case"returning_visitor":case"user_type":case"cities":case"languages":case"countries":case"postal_code":case"website":case"company":case"creation_time":case"last_activity":l=a(),u=!0;break;case"phone":l=a()&&a().getExtra("phone");break;case"email":l=a()&&a().email;break;default:l=a()&&a().getExtra(r[s][0])}if(!l)break}["messages","emails","sms"].includes(o.type)&&!a()&&(l=!1),l&&(u?o.id in this.busy||(ie.ajax({function:"automations-validate",automation:o},e=>{!1!==e&&this.runAll_final(o,d,c),delete this.busy[o.id]}),this.busy[o.id]=!0):"messages"==o.type&&re.registration(!0)||this.runAll_final(o,d,c))}},runAll_final:function(t,i,s){i?this.scroll_position_intervals[t.id]=setInterval(()=>{e(window).scrollTop()>parseInt(i)&&(s?setTimeout(()=>{this.run(t)},1e3*parseInt(s)):this.run(t),clearInterval(this.scroll_position_intervals[t.id]))},1e3):s?this.timeout_queue.includes(t.id)||(setTimeout(()=>{this.run(t)},1e3*parseInt(s)),this.timeout_queue.push(t.id)):this.run(t)},run:function(e){if(!this.history.includes(e.id))switch(e.type){case"messages":case"emails":case"sms":if((!se.active||se.started)&&!(e.id in this.busy)){if("messages"==e.type&&re.chat_open){let e=!!re.conversation&&re.conversation.getLastUserMessage(!1,"no-bot");if(e&&Date.now()-6e5<ie.unix(e.get("creation_time")))return}ie.ajax({function:"automations-run",automation:e},t=>{!1!==t&&(this.history.push(e.id),"messages"!=e.type||se.active||re.updateConversations()),delete this.busy[e.id]}),this.busy[e.id]=!0}break;case"popups":i("popup"+e.id)||setTimeout(()=>{if(re.chat_open){if(e.fallback){let t=!!re.conversation&&re.conversation.getLastUserMessage(!1,"no-bot");(!t||Date.now()-6e5>ie.unix(t.get("creation_time")))&&(re.sendMessage(w,(ie.null(e.title)?"":`*${e.title}*\n`)+e.message,[],!1,!1,0),i("popup"+e.id,!0),this.history.push(e.id))}}else re.popup(!1,{id:e.id,image:e.profile_image,title:e.title,message:e.message}),this.history.push(e.id)},1e3);break;case"design":e.background&&f.css("background-image",`url("${e.background}")`),e.brand&&f.find(".sb-brand img").attr("src",e.brand),e.title&&f.find(".sb-title").html(e.title),e.message&&f.find(".sb-text").html(e.message),e.icon&&l.find(".sb-chat-btn .sb-icon").attr("src",e.icon),(e.color_1||e.color_2||e.color_3)&&ie.ajax({function:"chat-css",color_1:e.color_1,color_2:e.color_2,color_3:e.color_3},e=>{c.append(`<style>${e}</style>`)}),this.history.push(e.id);break;case"more":let t={};if(e.department&&(re.default_department=e.department,t={function:"update-conversation-department",department:e.department}),e.agent&&(re.default_agent=e.agent,t={function:"update-conversation-agent",agent_id:e.agent}),e.tags&&(e.tags=e.tags.split(","),re.default_tags=e.tags,t={function:"update-tags",tags:e.tags,add:!0}),re.conversation.id&&(e.tags||e.agent||e.department)&&(t.conversation_id=re.conversation.id,ie.ajax(t)),e.articles||e.articles_category){let t=l.find(".sb-dashboard-articles > .sb-articles");re.articles_allowed_ids=e.articles,re.articles_category=e.articles_category,t&&re.getArticles(e.articles,e=>{let i="";for(var s=0;s<2;s++)i+=`<div data-id="${e[s].id}"><div>${e[s].title}</div><span>${e[s].content}</span></div>`;t.html(i)},e.articles_category,2)}this.history.push(e.id)}}},flashNotification:function(){clearInterval(j),j=setInterval(function(){re.notifications.length&&(document.title=document.title==O?"("+re.notifications.length+") "+s("New message"+(re.notifications.length>1?"s":"")):O)},2e3)},calculateLabelDates:function(){($||this.chat_open)&&(N=h.find(".sb-label-date"))},calculateLabelDateFirst:function(){this.conversation.messages.length||h.append(`<div class="sb-label-date"><span>${s("Today")}</span></div>`)},playSound:function(e=!1){this.audio.play();let t=e||($?SB_ADMIN_SETTINGS.sound.repeat:P.sound.repeat);t&&!this.tab_active&&(clearInterval(this.audio_interval),this.audio_interval=setInterval(()=>{this.audio.play(),--t||clearInterval(this.audio_interval)},1e3*this.audio.duration+1500))},isConversationAllowed:function(e,t){return(!P.tickets_hide||E&&"tk"==e||!E&&"tk"!=e)&&(![3,4,"3","4"].includes(t)||!E&&!P.close_chat||E&&!P.tickets_close)}};window.SBChat=re;var le={rich_messsages:{email:"",button:"",video:"",image:"",woocommerce_button:"",rating:"",chips:'<div class="sb-buttons">[options]</div>',buttons:'<div class="sb-buttons">[options]</div>',select:'<div class="sb-select"><p></p><ul>[options]</ul></div>',list:'<div class="sb-text-list">[values]</div>',"list-image":'<div class="sb-image-list">[values]</div>',table:"<table><tbody>[header][values]</tbody></table>",inputs:'<div class="sb-form">[values]</div>',card:'<div class="sb-card">[settings]</div>',share:'<div class="sb-social-buttons">[settings]</div>',slider:'<div class="sb-slider"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>',"slider-images":'<div class="sb-slider sb-slider-images"><div>[items]</div></div><div class="sb-slider-arrow sb-icon-arrow-left[class]"></div><div class="sb-slider-arrow sb-icon-arrow-right sb-active[class]"></div>'},cache:{},duplicated_email:!1,generate:function(t,i,n=""){let o,r=!0,c=t.id?t.id:ie.random(),d=new ne({});if(i in this.rich_messsages)o=this.rich_messsages[i];else if(i in this.cache)o=this.cache[i];else{if(!this.isShortcode(i))return!1;t.id||(c=i),o='<div class="sb-rich-loading sb-loading"></div>',ie.ajax({function:"get-rich-message",name:i,settings:t},s=>{s=this.initInputs(s),"timetable"==i&&(s=this.timetable(s)),e($&&"chatbot"==SBAdmin.active_admin_area?".sb-playground":l).find(`.sb-rich-message[id="${c}"]`).html(`<div class="sb-content">${s}</div>`),this.cache[i]=s,re.scrollBottom(re.dashboard),ie.event("SBRichMessageShown",{name:i,settings:t,response:s})}),r=!1}let u=t.disabled;if(r){let n,r="";switch(i){case"email":let l=[],c=a().email,d="#"==a().get("last_name").charAt(0);"true"==t.name&&l.push(["first_name","true"==t["last-name"]?"First name":"Name",d?"":"true"==t["last-name"]?a().get("first_name"):a().name,"text",!0]),"true"==t["last-name"]&&l.push(["last_name","Last name",d?"":a().get("last_name"),"text",!0]);for(p=0;p<l.length;p++)o+=`<div id="${l[p][0]}" data-type="text" class="sb-input sb-input-text"><span class="${l[p][2]?"sb-active sb-filled":""}">${s(l[p][1])}</span><input value="${l[p][2]}" autocomplete="false" type="${l[p][3]}" ${l[p][4]?"required":""}></div>`;if("true"==t.phone){let e=a().getExtra("phone");this.cache.phone||(this.cache.phone=!0,ie.ajax({function:"get-select-phone"},e=>{this.cache.phone=e,h.find("#phone .sb-select-phone").html(e)})),o+=`<div id="phone" data-type="select-input" class="sb-input sb-input-select-input"><span class="${e?"sb-active sb-filled":""}">${s("Phone")}</span><div class="sb-select-phone">${this.cache.phone?this.cache.phone:""}</div><input autocomplete="false" type="text" data-phone="true"${"false"!=t["phone-required"]?" required":""}></div>`}o+=`<div id="email" data-type="email" class="sb-input sb-input-btn"><span class="${c?"sb-active sb-filled":""}">${s(ie.null(t.placeholder)?"Email":t.placeholder)}</span><input value="${c}" autocomplete="off" type="email" required><div class="sb-submit sb-icon-arrow-right"></div></div>`;break;case"image":o=`<div class="sb-image"><img loading="lazy" src="${t.url}"></div>`;break;case"video":o=`<iframe loading="lazy"${t.height?` height="${t.height}"`:""} src="https://${"youtube"==t.type?"www.youtube.com/embed/":"player.vimeo.com/video/"}${t.id}" allowfullscreen></iframe>`;break;case"select":n=t&&t.options?t.options.replace(/\\,/g,"{R}").split(","):[];for(p=0;p<n.length;p++){let e=n[p].replace(/{R}/g,",");r+=`<li data-value="${ie.stringToSlug(e)}">${s(e)}</li>`}o=o.replace("[options]",r);break;case"chips":case"buttons":n=t&&t.options?t.options.replace(/\\,/g,"{R}").split(","):[];for(p=0;p<n.length;p++)r+=`<div class="sb-btn sb-submit">${s(n[p].replace(/{R}/g,","))}</div>`;o=o.replace("[options]",r);break;case"button":if(t&&t.link){let e=t.link.includes("calendly.com");o=`<a ${e?'data-action="calendly" data-extra="'+t.link+"|"+(t.success?t.success.replaceAll('"',"'"):"")+'" ':""}href="${e?"#":t.link.replace(/<i>/g,"_").replace(/<\/i>/g,"_")}"${t.target&&!e?' target="_blank"':""} class="sb-rich-btn sb-btn${"link"==t.style?"-text":""}">${s(t.name)}</a>`}break;case"list":if(t.values){n=t.values.replace(/\\,/g,"{R}").replace(/\\:/g,"{R2}").replace(/:\/\//g,"{R3}").split(",");let a="list"==i,l=a&&n.length&&n[0].indexOf(":")>0;a&&!l&&(o=o.replace("sb-text-list","sb-text-list sb-text-list-single")),t.numeric&&(o=o.replace("sb-text-list","sb-text-list sb-text-list-numeric"));for(p=0;p<n.length;p++){let t=n[p].replace(/{R}/g,","),i="-"===t.substr(0,1);r+=l&&t.includes(":")?`<div><div>${s(t.split(":")[0].replace(/{R2}/g,":").replace(/{R3}/g,"://"))}</div><div>${s(t.split(":")[1].replace(/{R2}/g,":").replace(/{R3}/g,"://"))}</div></div>`:`<div${i?' data-inner="true"':""}>${e.trim(s((i?t.substr(1):t).replace(/{R2}/g,":").replace(/{R3}/g,"://")))}</div>`}o=o.replace("[values]",r)}break;case"list-image":if(t.values){n=t.values.split(",");for(p=0;p<n.length;p++){let e=n[p].replace("://","///").split(":");r+=`<div><div class="sb-thumb" style="background-image:url('${e[0].replace("///","://")}')"></div><div class="sb-list-title">${e[1]}</div><div>${e[2]}</div></div>`}o=o.replace("[values]",r)}break;case"table":if(t.values){n=t.header.split(","),r+="<tr>";for(p=0;p<n.length;p++)r+=`<th>${n[p]}</th>`;r+="</tr>",o=o.replace("[header]",r),r="",n=t.values.split(",");for(p=0;p<n.length;p++){let e=n[p].split(":");r+="<tr>";for(var g=0;g<e.length;g++)r+=`<td>${e[g]}</td>`;r+="</tr>"}o=o.replace("[values]",r)}break;case"inputs":if(t.values){n=t.values.split(",");for(p=0;p<n.length;p++)u&&!n[p]||(r+=`<div id="${ie.stringToSlug(n[p])}" data-type="text" class="sb-input sb-input-text"><span>${s(n[p])}</span><input autocomplete="false" type="text" required></div>`);r+='<div class="sb-btn sb-submit">'+s(t.button?t.button:"Send now")+"</div>",o=o.replace("[values]",r)}break;case"card":r=`${t.image?`<div class="sb-card-img" style="background-image:url('${t.image}')"></div>`:""}<div class="sb-card-header">${t.header}</div>${t.extra?`<div class="sb-card-extra">${t.extra}</div>`:""}${t.description?`<div class="sb-card-description">${t.description}</div>`:""}${t.link?`<a class="sb-card-btn" href="${t.link}"${t.target?' target="_blank"':""}>${s(t["link-text"])}</a>`:""}`,o=o.replace("[settings]",r);break;case"share":let f=t.channels?t.channels.replace(/ /g,"").split(","):["fb","tw","li","wa","pi"],m="";for(p=0;p<f.length;p++){switch(f[p]){case"fb":m="www.facebook.com/sharer.php?u=";break;case"tw":m="twitter.com/intent/tweet?url=";break;case"li":m="www.linkedin.com/sharing/share-offsite/?url=";break;case"wa":m="web.whatsapp.com/send?text=";break;case"pi":m="www.pinterest.com/pin/create/button/?url="}r+=`<div class="sb-${f[p]} sb-icon-social-${f[p]}" data-link="https://${m}${encodeURIComponent(t[f[p]])}"></div>`}o=o.replace("[settings]",r);break;case"slider":let v=0;for(p=1;p<16&&"header-"+p in t;p++)r+=`<div>${"image-"+p in t?`<div class="sb-card-img" style="background-image:url('${t["image-"+p]}')"></div>`:""}<div class="sb-card-header">${t["header-"+p]}</div>${"extra-"+p in t?`<div class="sb-card-extra">${t["extra-"+p]}</div>`:""}${"description-"+p in t?`<div class="sb-card-description">${t["description-"+p]}</div>`:""}${"link-"+p in t?`<a class="sb-card-btn" href="${t["link-"+p]}"${t.target?' target="_blank"':""}>${s(t["link-text-"+p])}</a>`:""}</div>`,v++;o=o.replace("[items]",r).replace(/\[class\]/g,1==v?" sb-hide":"");break;case"slider-images":if(t.images){let e=t.images.split(",");for(var p=0;p<e.length;p++)r+=`<div class="sb-card-img" data-value="${e[p]}" style="background-image:url('${e[p]}')"></div>`;o=o.replace(/\[class\]/g,1==e.length?" sb-hide":"")}o=o.replace("[items]",r);break;case"woocommerce_button":t.settings=`checkout:${t.checkout},coupon:${t.coupon}`,o=`<a href="#" data-ids="${t.ids}" class="sb-rich-btn sb-btn">${t.name}</a>`;break;case"rating":o=`<div class="sb-rating-message sb-rating-${1==t.value?"positive":"negative"}"><div><i class="sb-icon-${1==t.value?"like":"dislike"}"></i> ${s(1==t.value?"Helpful":"Not helpful")}</div>${t.message?"<div>"+t.message+"</div>":""}</div>`,t.message=!1}}return`<div id="${c}" data-type="${i}"${u?'disabled="true"':""}${t.settings?` data-settings="${t.settings}"`:""}class="sb-rich-message sb-rich-${i} ${n}">`+(t.title?`<div class="sb-top">${d.render(s(t.title))}</div>`:"")+(t.message?`<div class="sb-text">${d.render(s(t.message))}</div>`:"")+`<div class="sb-content">${o}</div>${"email"==i?`<div data-success="${t.success?t.success.replace(/"/g,""):""}" class="sb-info"></div>`:""}</div>`},submit:function(i,n,o){if(!$&&!t(o)&&!this.is_busy){let t="",c="",d={},u=e(i).find("[data-success]").length?e(i).find("[data-success]").attr("data-success"):"",h=e(i).closest(".sb-rich-message").attr("id"),g=e(i).closest("[data-id]").attr("data-id"),p="",f={"rich-messages":{}},m=0==a()?{profile_image:"",first_name:"",last_name:"",email:"",password:"",user_type:""}:{profile_image:a().image,first_name:a().get("first_name"),last_name:a().get("last_name"),email:a().email,password:"",user_type:""},v={},_=e(o),b="",y=!1,A=!1!==re.conversation,k={},C={};if(ie.null(g))g=-1;else{let e=re.conversation.getMessage(g);p=e.message,(f=e.payload())["rich-messages"]||(f["rich-messages"]={})}switch(e(o).hasClass("sb-btn")||e(o).hasClass("sb-select")||e(o).hasClass("sb-submit")||(_=e(o).closest(".sb-btn,.sb-select")),e(i).find(".sb-info").html("").sbActive(!1),n){case"email":if(v=ce.getAll(i),e.each(v,function(e,t){v[e]=t[0]}),v.first_name&&(m.user_type="user",v.last_name||(m.last_name="")),v.phone&&(k={phone:[v.phone,"Phone"]}),e.extend(m,v),t="Please fill in all required fields and make sure the email is valid.",u&&(u=s(u).replace("{user_email}",m.email).replace("{user_name_}",m.first_name+(v.last_name?" "+m.last_name:""))),l.sbActive()){let e=l.attr("data-otp");v.otp=!!e&&[e,i.find("#otp input").val()]}f["rich-messages"][h]={type:n,result:v},f.event="update-user",d={function:"update-user-and-message",settings:m,settings_extra:k,payload:f},y={settings:m,settings_extra:k};break;case"registration":let l=i.find("#otp");if(v=ce.getAll(i.find(".sb-form-main")),k=ce.getAll(i.find(".sb-form-extra")),e.each(v,function(e,t){v[e]=t[0]}),e.extend(m,v),C=e.extend({},m),u&&(u=s(u)),P.registration_details){u+='[list values="';for(var r in m){let e=m[r].replace(/:|,/g,"");e&&("profile_image"==r&&(e=e.substr(e.lastIndexOf("/")+1)),["password","password-check","envato-purchase-code","otp"].includes(r)?(e="********",C[r]="********"):u+=m[r]?`${s(ie.slugToString(r.replace("first_name","name")))}:${e},`:"")}for(var r in k)k[r][0]&&(u+=`${s(k[r][1].replace(/:|,/g,""))}:${k[r][0].replace(/:|,/g,"")},`);u=u.slice(0,-1)+'"]'}if(l.sbActive()){let e=l.attr("data-otp");m.otp=!!e&&[e,i.find("#otp input").val()]}m.user_type="user",f["rich-messages"][h]={type:n,result:{user:C,extra:k}},f.event="update-user",d=P.registration_otp&&m.email&&!m.otp?{function:"otp",email:m.email}:{function:a()?"update-user-and-message":"add-user-and-login",settings:m,settings_extra:k,payload:f},t=ce.getRegistrationErrorMessage(i),y={settings:m,settings_extra:k};break;case"chips":case"select":case"buttons":v=ie.escape(e(o).html()),u&&(u=s(u)+` *${v}*`),f["rich-messages"][h]={type:n,result:v},d={function:"update-message",payload:f},b=v,"chips"==n&&(re.sendMessage(a().id,v,[],!1,{id:h,event:"chips-click",result:v},"sb-human-takeover"==h&&0==_.index()&&2),"sb-human-takeover"==h&&0==e(o).index()&&de.dialogflow.humanTakeover(),e(o).closest(".sb-content").remove());break;case"inputs":if(v=ce.getAll(i),t="All fields are required.",u){u=s(u)+' [list values="';for(var r in v)u+=`${s(v[r][1].replace(/:|,/g,""))}:${v[r][0].replace(/:|,/g,"")},`;u=u.slice(0,-1)+'"]'}f["rich-messages"][h]={type:n,result:v},d={function:"update-message",payload:f},y={settings:v}}if(c=p.substr(p.indexOf("["+n)),c=c.substr(0,c.indexOf("]")+1),t&&ce.errors(i))return ce.showErrorMessage(i,t),_.sbLoading(!1),(re.dashboard||A&&re.conversation.getLastMessage().id==g)&&re.scrollBottom(),!1;if(!u&&"registration"!=n){let e=this.shortcode(c),t=e[1].id?`id="${e[1].id}"`:"",i=e[1].title?`title="${e[1].title}"`:"",s=e[1].message?`message="${e[1].message}"`:"",a="";if(["inputs","email"].includes(n)){for(var r in v)a+=v[r]+",";a=`values="${a.slice(0,-1)}"`}else a=`options="${v}"`;u=`[${"email"==n?"inputs":n} ${t} ${i} ${s} ${a} disabled="true"]`}-1!=g&&(u=u.replace(/<br>/g,"\n"),e.extend(d,{message_id:g,message:p?"chips"==n?p.replace("]",' disabled="true"]'):p.replace(c,u):u,payload:f})),ie.ajax(d,t=>{if(t&&!ie.errorValidation(t)){switch(n){case"email":for(var r in m)a().set(r,m[r]);for(var r in k)a().setExtra(r,k[r][0]);ie.loginCookie(t[1]),"sb-follow-up"==h&&ie.ajax({function:"subscribe-email",email:a().email}),re.automations.runAll(),ie.event("SBNewEmailAddress",{id:h,name:a().name,email:a().email});break;case"registration":let o=i.find("#otp");if(P.registration_otp&&!o.sbActive())return o.attr("data-otp",t).sbActive(!0),o.find("input").attr("required",!0),ce.showErrorMessage(i,s("Please check your email for the one-time code.")),re.scrollBottom(),void _.sbLoading(!1);if(ie.loginCookie(t[1]),m.id=t[0].id,a()){for(var r in m)a().set(r,m[r]);for(var r in k)a().setExtra(r,k[r][0]);re.automations.runAll(),re.welcome()}else{a(new ae(t[0]));for(var r in k)a().setExtra(r,k[r][0]);this.duplicated_email&&!P.init_dashboard&&(G="open-conversation"),se.start(),re.initChat(),this.duplicated_email||P.init_dashboard&&l.find(".sb-departments-list").length||!u||re.sendMessage(w,u,[],!1,!1,3)}re.dashboard&&(l.removeClass("sb-init-form-active"),e(i).remove(),re.isInitDashboard()||P.init_dashboard&&this.duplicated_email||re.hideDashboard()),P.wp_registration&&m.email&&m.password?de.wordpress.ajax("wp-registration",{user_id:t[0].id,first_name:t[0].first_name,last_name:t[0].last_name,password:m.password,email:m.email}):"wp"==P.wp_users_system&&de.wordpress.ajax("wp-login",{user:m.email,password:m.password}),delete this.cache.registration,setTimeout(()=>{ie.event("SBRegistrationForm",{id:h,conversation_id:!!re.conversation&&re.conversation.id,user:m,extra:f["rich-messages"][h].result.extra})},5e3);break;case"buttons":re.scrollBottom()}-1==g?e(o).closest(".sb-rich-message").html(u):(_.sbLoading(!1),f.type&&"close-message"==f.type||S||re.setConversationStatus(2)),["login","chips"].includes(n)||!P.dialogflow_send_user_details&&["email","registration"].includes(n)||de.dialogflow.message(`${h}${b?"|"+b:""}`,[],!1,y),!P.slack_active||S&&!de.dialogflow.humanTakeoverActive()||re.slackMessage(a().id,a().name,a().image,u),se.active&&re.update(),"registration"!=n&&"email"!=n&&ie.event("SBRichMessageSubmit",{result:t,data:f["rich-messages"][h],id:h})}else"registration"==n&&ie.errorValidation(t,"duplicate-email")?(ie.ajax({function:"otp",email:m.email},e=>{let t=i.find("#otp");t.attr("data-otp",e).sbActive(!0),t.find("input").attr("required",!0),ce.showErrorMessage(i,s("This email is already in use. Please check your email for the one-time code.")),i.find(".sb-submit").html(s("Sign in")),re.scrollBottom()}),this.duplicated_email=!0):(this.duplicated_email=!1,ce.showErrorMessage(i,ce.getRegistrationErrorMessage(t,"response"))),re.dashboard&&re.scrollBottom(),_.sbLoading(!1)})}},shortcode:function(t){let i={},s=t.includes(" ")?t.substr(1,t.indexOf(" ")-1):t.slice(1,-1);if(/\?|"|'|`|\*/gi.test(s))return[!1,!1];let a=(t=t.slice(1,-1).substr(s.length+1)).split('" ');for(var n=0;n<a.length;n++)if(a[n].includes("=")){let t=[a[n].substr(0,a[n].indexOf("=")),a[n].substr(a[n].indexOf("=")+2)];i[e.trim(t[0])]=t[1].replace(/"/g,"")}return[s,i]},initInputs:function(t){return(t=e(e.parseHTML("<div>"+t+"</div>"))).find(".sb-input input").each(function(){e(this).val()&&e(this).siblings().addClass("sb-active sb-filled")}),t.html()},timetable:function(t){let i=e(e.parseHTML(`<div>${t}</div>`)),a=i.find("[data-offset]").attr("data-offset");return a=ie.null(a)?0:parseInt(a),i.find("[data-time]").each(function(){let n=e(this).attr("data-time").split("|");t="";for(var o=0;o<n.length;o++){if("closed"==n[o]){t+=s("Closed");break}if(n[o]){let e=n[o].split(":"),i=ie.convertUTCDateToLocalDate(`01/01/2000 ${e[0]}:${e[1]}`,a);t+=i.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})+(0==o||2==o?`<span>${s("to")}</span>`:1==o&&n[o+1]?"<br />":"")}}i.find(" > div > span").html(`<i class="sb-icon-clock"></i> ${s("Time zone")} ${Intl.DateTimeFormat().resolvedOptions().timeZone}`),e(this).html(t)}),i.html()},sliderChange:function(e,t="left"){let i=h.find(`#${e}`);if(i.length&&!i.hasClass("sb-moving")){let e=i.find(".sb-slider > div > div"),s=e.eq(0),a=Math.ceil(s.closest(".sb-slider").width()),n="right"==t?-1:1,o=parseFloat(parseFloat(parseFloat(s.css("margin-left"))+a*n)),r=a*(e.length-1)*-1;o<1&&o>=r&&(s.css("margin-left",o+"px"),i.addClass("sb-moving"),setTimeout(()=>{i.removeClass("sb-moving")},1200)),i.find(".sb-icon-arrow-right").sbActive(!(r>o-15&&r<o+15)),i.find(".sb-icon-arrow-left").sbActive(o<-10)}},calendly:{script_loaded:!1,load:function(t,i,a){t=t.split("|"),this.script_loaded?this.load_(t[0],i):e.getScript("https://assets.calendly.com/assets/external/widget.js",()=>{this.script_loaded=!0,window.addEventListener("message",function(e){"https://calendly.com"===e.origin&&"calendly.event_scheduled"==e.data.event&&(re.updateMessage(a,s(t[1]?t[1]:"Booking completed.")),b.sbActive(!1))}),this.load_(t[0],i)},!0)},load_:function(e,t){Calendly.initInlineWidget({url:(e.includes("http")?"":"https://")+e+"?hide_landing_page_details=1&hide_event_type_details=1&hide_gdpr_banner=1",parentElement:b.find("> div").eq(1),prefil:"user"==a().type?{name:a().name,email:a().email}:{}}),b.find("> div:first-child > div").html(s(t)),b.sbActive(!0).attr("data-id","calendly")}},rating:function(e=!1){b.find("> div:first-child > div").html(s("Rate your experience")),b.find("> div:last-child").html(`${P.rating_message?`<div class="sb-input sb-input-textarea"><textarea placeholder="${s("Add a message here...")}"></textarea></div>`:""}<div class="sb-rating"><div><i data-rating="positive" class="sb-submit sb-icon-like"><span>${s("Helpful")}</span></i><i data-rating="negative" class="sb-submit sb-icon-dislike"><span>${s("Not helpful")}</span></i></div></div>`),b.sbActive(!0).attr("data-id","rating").attr("data-close-chat",e?"true":"").css("max-height",(P.rating_message?167:80)+"px")},isShortcode:function(e){return e in this.rich_messsages||$&&SB_ADMIN_SETTINGS.rich_messages.includes(e)||!$&&P.rich_messages.includes(e)}};window.SBRichMessages=le;var ce={getAll:function(t){let i={};return e(t).find(".sb-input[id]").each((t,s)=>{i[e(s).attr("id")]=this.get(s)}),i},get:function(t){let i=(t=e(t)).data("type"),a=s(ie.escape(t.find(" > span").html()));switch(i){case"image":let e=t.find(".image").attr("data-value");return[ie.null(e)?"":e,a];case"select":return[ie.escape(t.find("select").val()),a];case"select-input":let s=t.find("select,input[disabled]");return[ie.escape((s.is("select")||s.is("input")?s.val():t.find(".sb-select").length?t.find(".sb-select > p").attr("data-value"):t.find("> div").html())+t.find("> input").val()),a];default:let n=t.find("input");return[ie.escape(n.length?n.val():t.find("[data-value]").attr("data-value")),a]}},set:function(t,i){if((t=e(t)).length){switch(t.data("type")){case"image":i?t.find(".image").attr("data-value",i).css("background-image",`url("${i}")`):t.find(".image").removeAttr("data-value").removeAttr("style");break;case"select":t.find("select").val(i);break;default:t.find("input,textarea").val(i)}return!0}return!1},clear:function(t){e(t).find(".sb-input,.sb-setting").each((t,i)=>{this.set(i,""),e(i).find("input, select, textarea").removeClass("sb-error")}),this.set(e(t).find("#user_type"),"user")},errors:function(t){let i=!1,s=e(t).find("input, select, textarea").removeClass("sb-error");return s.each(function(t){let a=e.trim(e(this).val()),n=e(this).attr("type"),o=e(this).prop("required");(o&&!a||(o||a)&&("password"==n&&(a.length<8||s.length>t+1&&"password"==s.eq(t+1).attr("type")&&s.eq(t+1).val()!=a)||"email"==n&&(a.indexOf("@")<0||a.indexOf(".")<0||/;|:|\/|\\|,|#|"|!|=|\+|\*|{|}|[|]|£|\$|€|~|'|>|<|\^|&/.test(a))||e(this).attr("data-phone")&&a&&(!e(this).parent().find("select").val()&&!e(this).prev().find("> div > p").attr("data-value")&&!e(this).parent().find("div").html().trim().startsWith("+")||isNaN(a)||a.includes("+")||a.length<5)))&&(i=!0,e(this).addClass("sb-error"))}),(s=e(t).find("[data-required]").removeClass("sb-error")).each(function(){ie.null(e(this).attr("data-value"))&&(e(this).addClass("sb-error"),i=!0)}),i},showErrorMessage:function(t,i){e(t).find(".sb-info").html(s(i)).sbActive(!0),clearTimeout(I),I=setTimeout(function(){e(t).find(".sb-info").sbActive(!1)},7e3)},showSuccessMessage:function(t,i){e(t).find(".sb-info").remove(),e(t).addClass("sb-success").find(".sb-content").html(`<div class="sb-text">${i}</div>`)},getRegistrationErrorMessage(t,i="validation"){let a="";return"response"==i?ie.errorValidation(t,"duplicate-email")?"This email is already in use. Please use another email.":ie.errorValidation(t,"duplicate-phone")?"This phone number is already in use. Please use another number.":ie.errorValidation(t,"invalid-envato-purchase-code")?"Invalid Envato purchase code.":ie.errorValidation(t,"invalid-otp")?"Invalid one-time code.":"Error. Please check your information and try again.":(e(t).find(".sb-input:not(#password-check) [required]").each(function(){a+=", "+e(this).closest(".sb-input").find("span").html()+("password"==e(this).attr("type")?" ("+s("8 characters minimum")+")":"")}),`${a.substring(2)} ${s((a.includes(",")?"are":"is")+" required.")}`)}};window.SBForm=ce;var de={login:function(){return typeof SB_DEFAULT_USER!=W&&SB_DEFAULT_USER?[SB_DEFAULT_USER,"default"]:this.is("wp")&&typeof SB_WP_ACTIVE_USER!=W&&"wp"==P.wp_users_system?[[SB_WP_ACTIVE_USER,typeof SB_WP_AVATAR!=W?SB_WP_AVATAR:""],"wp"]:typeof SB_SHOPIFY_ACTIVE_USER!=W?[SB_SHOPIFY_ACTIVE_USER,"shopify"]:typeof SB_PERFEX_ACTIVE_USER!=W?[[SB_PERFEX_ACTIVE_USER,SB_PERFEX_CONTACT_ID],"perfex"]:typeof SB_WHMCS_ACTIVE_USER!=W?[SB_WHMCS_ACTIVE_USER,"whmcs"]:typeof SB_AECOMMERCE_ACTIVE_USER!=W&&[SB_AECOMMERCE_ACTIVE_USER,"aecommerce"]},is:function(e){return $?SBAdmin.apps.is(e):"wordpress"==e||"wp"==e?P.wp:e in P&&P[e]},shopify:{startCartSynchronization:function(){setInterval(()=>{a()&&fetch("/cart.js").then(e=>e.json()).then(e=>{e={total:e.total_price,currency:e.currency,items:e.items.map(e=>({id:e.product_id,price:e.price,handle:e.handle,title:e.title,quantity:e.quantity}))};let t=JSON.stringify(e);i("shopify-cart")!=t&&(i("shopify-cart",t),ie.ajax({function:"shopify-cart-sync",cart:e}))})},1e4)}},wordpress:{ajax:function(t,i,s=!1){typeof SB_WP_AJAX_URL!=W&&e.ajax({method:"POST",url:SB_WP_AJAX_URL,data:e.extend({action:"sb_wp_ajax",type:t},i)}).done(e=>{s&&s(e)})}},woocommerce:{updateCart:function(e,t,i=!1){de.wordpress.ajax(e,{product_id:t},i)},waitingList:function(e="request",t=!1){typeof SB_WP_WAITING_LIST!==W&&("request"!=e||SB_WP_WAITING_LIST&&ie.storageTime("waiting-list-"+SB_WP_PAGE_ID,24))&&a()&&ie.ajax({function:"woocommerce-waiting-list",product_id:!1===t?SB_WP_PAGE_ID:t,conversation_id:re.conversation.id,action:e,token:this.token},t=>{t&&(ie.storageTime("waiting-list-"+SB_WP_PAGE_ID),"request"!=e||re.chat_open&&!re.dashboard||re.updateConversations())})}},dialogflow:{token:i("dialogflow-token"),typing_enabled:!0,project_id:!1,busy:!1,message:function(t="",s=[],n=!1,o=!1,r=!1){if(!(t.length<2)||s.length){if(!r)for(var l=0;l<s.length;l++)s[l][0].includes("voice_message")&&(r=s[l][1]);if(this.active(!0,!0,!1)){let e=de.dialogflow.humanTakeoverActive();if(e&&!this.typing_enabled||this.typing(),this.chatbotLimit())return re.sendMessage(w,this.chatbotLimit());re.headerAgent(!0),setTimeout(()=>{let n=re.conversation;ie.ajax({function:"dialogflow-message",conversation_id:!!n&&n.id,message:t,attachments:s,parameters:o,token:this.token,dialogflow_language:i("dialogflow-language")?i("dialogflow-language"):SB_LANG,project_id:this.project_id,session_id:a().id+"-"+n.id,audio:r},s=>{if(re.typing(-1,"stop"),!1!==s){if(s.response&&s.response.error)return console.error(s.response);if(s.human_takeover)return re.offlineMessage(),re.followUp(),this.active(!1);if(s.language_detection&&!i("dialogflow-language")&&i("dialogflow-language",[s.language_detection]),s.user_language&&!i("dialogflow-language")&&a().setExtra("language",s.user_language),s.translations&&(P.translations=s.translations),!ie.errorValidation(s)){let r=!!s.response.queryResult&&s.response.queryResult,l=r&&("input.unknown"==r.action||r.match&&"NO_MATCH"==r.match.matchType),c=s.messages&&Array.isArray(s.messages)?s.messages:[];if(clearTimeout(I),this.token!=s.token&&(this.token=s.token,i("dialogflow-token",s.token)),l?e&&(this.typing_enabled=!1):this.typing_enabled=!0,r){if(r.action){let e=r.action;"end"==e&&this.active(!1),ie.event("SBBotAction",e)}for(o=0;o<c.length;o++){if(c[o].payload){let e=["human-takeover","redirect","woocommerce-update-cart","woocommerce-checkout","open-article","transcript","department","agent","send-email","rich-message","tags"],t=c[o].payload;if(ie.null(t)&&(t=[]),e[0]in t&&!0===t[e[0]]&&this.humanTakeover(),e[1]in t&&setTimeout(function(){t["new-window"]?window.open(t[e[1]]):document.location=t[e[1]]},500),e[2]in t){let i=t[e[2]];de.woocommerce.updateCart(i[0],i[1],e=>{e&&ie.event("SBWoocommerceCartUpdated",{action:i[0],product:i[1]})})}if(e[3]in t&&!0===t[e[3]]&&de.wordpress.ajax("url",{url_name:"checkout"},e=>{setTimeout(()=>document.location=e,500)}),e[4]in t&&re.showArticles(t[e[4]]),e[5]in t&&t[e[5]]&&ie.ajax({function:"transcript",conversation_id:n.id,type:"txt"},i=>{"email"==t[e[5]]&&a().email?re.sendEmail(t.message?t.message:"",[[i,i]],n.id):window.open(i)}),e[6]in t&&ie.ajax({function:"update-conversation-department",conversation_id:n.id,department:t[e[6]],message:n.getLastUserMessage().message}),e[7]in t&&ie.ajax({function:"update-conversation-agent",conversation_id:n.id,agent_id:t[e[7]],message:n.getLastUserMessage().message}),e[8]in t){let i=t[e[8]];re.sendEmail(i.message,i.attachments,"active_user"==i.recipient)}e[9]in t&&re.sendMessage(w,t[e[10]]),e[10]in t&&ie.ajax({function:"update-tags",conversation_id:n.id,tags:t[e[11]]}),ie.event("SBBotPayload",t)}this.chatbotLimit(!1),i("dialogflow-language")||!r.languageCode||SB_LANG&&r.languageCode==SB_LANG[0]||i("dialogflow-language",[r.languageCode])}if(r.diagnosticInfo){r.diagnosticInfo.end_conversation&&this.active(!1)}}if(P.slack_active&&c&&(!S||e))for(var o=0;o<c.length;o++)re.slackMessage(a().id,P.bot_name,P.bot_image,c[o].message,c[o].attachments);ie.event("SBBotMessage",{response:s,message:t})}}}),this.busy=!0},!1!==n?n:0==P.bot_delay?2e3:parseInt(P.bot_delay))}else this.active(!0,!1,!0)&&!e(".sb-emoji-list").html().includes("<li>"+t+"</li>")&&this.openAI(t,!1,r,s)}},openAI:function(t,s=!1,n=!1,o=[]){if(P.open_ai_active){if(re.headerAgent(!0),re.agent_id!=w||de.dialogflow.humanTakeoverActive()&&!this.typing_enabled||this.typing(),this.chatbotLimit())return re.sendMessage(w,this.chatbotLimit());setTimeout(()=>{ie.ajax({function:"open-ai-message",message:t,conversation_id:!!re.conversation&&re.conversation.id,audio:n,extra:{token:de.dialogflow.token},attachments:o,context:!!P.open_ai_context_awareness&&(document.title.toUpperCase()+"\n\n\n"+e('meta[name="description"]').attr("content")||"")},e=>{this.busy=!1,re.typing(-1,"stop"),ie.event("SBOpenAIMessage",{response:e,message:t}),e&&(e[0]||e[5])?(P.chatbot_limit&&this.chatbot_limit++,P.slack_active&&t&&(!S||de.dialogflow.humanTakeoverActive())&&re.slackMessage(a().id,P.bot_name,P.bot_image,e[1]),e[2]&&de.dialogflow.token!=e[2]&&(de.dialogflow.token=e.token,i("dialogflow-token",e.token)),e[3]&&(re.offlineMessage(),re.followUp()),e[5]&&(e[5].redirect&&setTimeout(()=>{document.location=e[5].redirect},500),e[5].open_article&&re.showArticles(e[5].open_article),"conversation-status-update-3"==e[5].event&&re.conversationArchived()),this.chatbotLimit(!1)):!1!==e[1]&&ie.error(e[1].error?e[1].error.message:e[1],"SBApps.dialogflow.openAI"),s&&s(e)}),this.busy=!0},0==P.bot_delay?2e3:parseInt(P.bot_delay))}},flowOnLoad(){P.flow_on_load&&!i("flow-on-load")&&a()&&(re.conversation?ie.ajax({function:"run-flow-on-load",message:P.flow_on_load,conversation_id:re.conversation.id}):re.newConversation(3,a().id,"",[],null,null,()=>{ie.ajax({function:"run-flow-on-load",message:P.flow_on_load,conversation_id:re.conversation.id})}),i("flow-on-load",!0))},typing:function(){clearTimeout(L),L=setTimeout(()=>{re.typing(-1,"start")},1e3)},active:function(e=!0,t=!0,i=!0){if(!1===e)return re.conversation.set("is_human_takeover",!0),!1;if("activate"==e&&re.conversation.set("is_human_takeover",!1),!$&&de.dialogflow.humanTakeoverActive()&&P.dialogflow_human_takeover_disable_chatbot)return!1;let s=!($||re.conversation&&de.dialogflow.humanTakeoverActive()&&re.agent_online||P.dialogflow_office_hours&&P.office_hours);return t&&i?(P.dialogflow_active||P.open_ai_active)&&s:(!t||P.dialogflow_active)&&(!i||P.open_ai_active)&&s},welcome:function(e=!1,t=!1){ie.ajax({function:"dialogflow-message",message:"",conversation_id:re.conversation.id,token:this.token,event:"Welcome",dialogflow_language:i("dialogflow-language")?i("dialogflow-language"):SB_LANG},()=>{e&&re.start(),t&&re.audio.play()})},humanTakeover:function(){ie.ajax({function:"dialogflow-human-takeover",conversation_id:re.conversation.id},()=>{re.offlineMessage(),re.followUp(),this.active(!1),P.queue_human_takeover&&(P.queue=!0,re.queue(re.conversation.id))})},humanTakeoverActive:function(){return!!re.conversation&&re.conversation.get("is_human_takeover")},translate:function(e,t,i,s,a){ie.ajax({function:"google-translate",strings:e,language_code:t,token:this.token,message_ids:s,conversation_id:a},e=>{this.token=e[1],i(e[0])})},chatbotLimit:function(e=!0){if(P.chatbot_limit){let s=i("chatbot_limit"),a=(new Date).getTime()/1e3;if(s||(s=[]),e){let e=a-P.chatbot_limit.interval,n=[];for(var t=0;t<s.length;t++)s[t]>e&&n.push(s[t]);if(i("chatbot_limit",n),n.length>=P.chatbot_limit.quota)return P.chatbot_limit.message}else s.push(a),i("chatbot_limit",s)}return!1}},aecommerce:{cart:function(){de.is("aecommerce")&&typeof SB_AECOMMERCE_CART!=W&&typeof SB_AECOMMERCE_ACTIVE_USER!=W&&i("aecommerce")!=JSON.stringify(SB_AECOMMERCE_CART)&&ie.ajax({function:"aecommerce-cart",cart:SB_AECOMMERCE_CART},()=>{i("aecommerce",JSON.stringify(SB_AECOMMERCE_CART))})}},martfury:{privateChat:function(){let t=e("#tab-vendor > h4,.ps-product__vendor > a");if(t.length){t=t.html().toLowerCase();for(var i=0;i<P.martfury.length;i++)if(t==P.martfury[i]["martfury-linking-store"].toLowerCase()){let e=P.martfury[i]["martfury-linking-agent"],t=ie.activeUser()?ie.activeUser().conversations:[];re.default_agent=e;for(var s=0;s<t.length;s++)if(t[s].get("agent_id")==e)return void re.openConversation(t[s].id);re.clear(),re.hideDashboard()}}}}};window.SBApps=de,e(document).ready(function(){if((l=e(".sb-admin, .sb-admin-start")).length)return $=!0,void r();let t,i,s=!1;if(typeof SB_INIT_URL!=W)SB_INIT_URL.indexOf(".js")<0&&(SB_INIT_URL+="/js/main.js?v=3.7.8"),t=SB_INIT_URL;else{let e=document.getElementsByTagName("script"),i=["init.js","main.js","min/init.min.js","min/main.min.js"];for(var a=0;a<e.length;a++){let o=e[a].src;if("sbinit"==e[a].id){t=o,s=s||t.includes("init.");break}for(var n=0;n<i.length;n++)if(o&&o.includes("/supportboard/js/"+i[n])){t=o,s=s||t.includes("init.");break}}}let o=ie.getURL(!1,t);if(o.url&&(t=o.url),typeof SB_DISABLED!=W&&SB_DISABLED)return;if(s)return void r();typeof SB_TICKETS==W&&"tickets"!=o.mode||(E=!0,o.mode="tickets"),o.cloud&&(H=o.cloud);let c=!(!te||"en"==Shopify.locale)&&Shopify.locale,d=t.lastIndexOf("main.min.js"),u=(i=t.substr(0,t.lastIndexOf("main.js")>0?t.lastIndexOf("main.js")-4:d-8))+"/include/init.php"+(o.lang?"?lang="+o.lang:"")+(c?"?lang_optional="+c:"")+(o.mode?"&mode="+o.mode:"")+(H?"&cloud="+H:"");ie.cors("GET",u.replace(".php&",".php?"),t=>{let s="body";E&&e("#sb-tickets").length&&(s="#sb-tickets"),e(s).append(t),ie.loadResource(i+"/css/"+(E?"tickets":"main")+".css"),E?ie.loadResource(i+"/apps/tickets/tickets"+(d>0?".min":"")+".js?v=3.7.8",!0,()=>{r()}):r(),o.lang&&(SB_LANG=[o.lang,$?"admin":"front"])})})}(jQuery);